---
title: "Aramburu Shorebird Survey"
author: Alex S.
output: 
  html_document:
    number_sections: no
    theme: journal
    toc: yes
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
date: "Last Updated: `r format(Sys.time(), '%Y-%m-%d')`" 
---

```{r setup, include=FALSE, echo=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      include = TRUE,
                      cache = TRUE,
                      warning = FALSE, 
                      message = FALSE)

library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(lubridate)
library(readxl)
library(broom)
library(tidyr)

# Utils
g <- function(.) glimpse(.)

medium_fonts <- ggplot2::theme_bw() +
  ggplot2::theme(
    plot.title = ggplot2::element_text(size = 14),
    axis.text.x = ggplot2::element_text(size = 12),
    axis.text.y = ggplot2::element_text(size = 12),
    axis.title.x = ggplot2::element_text(size = 12),
    axis.title.y = ggplot2::element_text(size = 12),
    # legend.title = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(size = 12),
    strip.text.x = ggplot2::element_text(size = 12),
    strip.text.y = ggplot2::element_text(size = 12)
  )

condition_colors <- c("before" = "#FDBF6F", 
                      "construction" = "#A6CEE3", 
                      "after" = "#33A02C")

refresh <- F

```


# Overview

EDA of shorebird data on Aramburu Island following shoreline, wetland, & terrestrial enhancements in 2011-2012. Pickleweed & Unnamed Island are used as controls.

## Goals

1) Is there enough data to make statements about changes in species over time? i.e. can we get statistical significance for differences between Aramburu & Pickelweed.
2) Has the number of species or abundance of any species changed over time on Aramburu vs Pickleweed? Have behaviors changed?
3) Are there differences between high/low tide? 
4) Are there obvious improvements to methodology we can make?

## Qs for Julia

- for a particular observation day it looks like each bird can be in there for every isle, tide, position, behabior, and observer(?)
- were both high and low tide measured for the same amount of time?
- generally ever sampled day is sampled at every tide and at all locations??
- Do we think different observers would have different bird counts?
- Are samples on different islands made on different times of day in a way that might affect results?
- behavior code S is very common but not in index. what is it?

## Data notes

- no obs in 1H 2009, 2H 2012, 2H 2015, and all of 2017
- Observations usually made on all islands on same day and both high and low tide.
- When a bird was not present there is usaally no entry, so need to make sure to fill with 0s. i.e. can't just average because 0-days won't be counted.
- A bird may have multiple rows per observation bc of different behaviors, positions, comments, etc. so important to group by species when doing presence counts.
- NB sometimes we analyze species **presence** (was there/was not) and sometimes individual **count** (how many)

# Load & format data

From Excel file:

ISLE CODES:   
AS = ARAMBURU, SOUTH END.   
AC = ARAMBURU CENTRAL.   
AN = ARAMBURU, NORTH END.    
U = UN-NAMED.   
P = PICKLEWEED.

POSITION CODES:  
V=VEGETATION.  
RS=ROCK/SAND.  
M=MUDFLAT.  
SW=STANDING IN WATER.   
FW=FLOATING ON WATER.  
OW=OVER WATER

BEHAVIOR CODES:  
R=ROOSTING/RESTING.  
F=FORAGING (probing, dabbling, diving, aerial surveying).  
O=OTHER (Comment)


**Keys:**
```{r keys, echo = T}
island_key <- data.frame(
  short_name = c("as", "ac", "an", "u", "p"),
  long_name = c("aramburu_south", "aramburu_central", "aramburu_north", "unnamed", "pickleweed")
)

position_key <- data.frame(
  short_name = c("v", "rs", "m", "sw", "fw", "ow"),
  long_name = c("vegetation", "rock_sand", "mudflat", "standing_in_water", "floating_on_water", "over_water")
)

behavior_key <- data.frame(
  short_name = c("r", "f", "o", "r/f"),
  long_name = c("roosting", "foraging", "other", "roosting/foraging")
)
```


**Load data:**
```{r load-data, echo = T, include = T}
if (refresh) {
  dat <- read_excel("data/SHOREBIRD_DATA_Complete_2018.xls", sheet = 1) %>% 
    rename_all(tolower) %>%
    select(-analyze, -`pre/post construction`) %>%
    rename(obs_date = date,
           tide_ft = `tide (ft)`,
           tide_hl = `high/low`, # I assume this is tide?
           island = `aram?`,
           aou_num = `aou num`,
           record_num = `record num`,
           gulls = gullls
    ) %>% 
    
    mutate(obs_date = as.Date(obs_date),
           month_no = lubridate::month(obs_date),
           year = lubridate::year(obs_date) # there were many missing year entries, populate here
    ) %>% 
    
    # pre/post improvements (see note under "Change Over Time")
    mutate(epoch = ifelse(obs_date < "2011-09-01", "before", 
                          ifelse(obs_date < "2012-09-01", "construction", "after"))) %>% 
    mutate(epoch = factor(epoch, levels = c("before", "construction", "after"))) %>% 
    
    # species names
    mutate(species = tolower(species)) %>% 
    mutate(species = ifelse(species %in% c("none", "-", "0", NA), "none", species)) %>% 
    mutate(is_bird = !(species %in% c("deer", "humans"))) %>% 
    
    # convert guild to logical
    mutate(shorebirds = grepl("x", tolower(shorebirds)),
           peeps = grepl("x", tolower(peeps)),
           gulls = grepl("x", tolower(gulls)),
           terns = grepl("x", tolower(terns)),
           wading = grepl("x", tolower(wading)),
           grebes = grepl("x", tolower(grebes))
    ) %>% 
    
    # Make MECE guild column (this will further be edited later)
    # In this data all peeps are also shorebirds and there's no "other" 
    # NB should not have any peeps bc classified as shorebirds
    mutate(guild = ifelse(shorebirds, "shorebirds", 
                          ifelse(peeps, "peeps", 
                                 ifelse(gulls, "gulls", 
                                        ifelse(terns, "terns", 
                                               ifelse(wading, "wading", 
                                                      ifelse(grebes, "grebes", NA))))))
    ) %>% 
    
    # clean up behaviors:
    mutate(behavior = ifelse(behavior %in% c("FO", "FV", "FW", "F?", "O,F"), "F", 
                             ifelse(behavior %in% c("O,F", "OW"), "O", 
                                    ifelse(behavior %in% c("R/F", "F/R"), "R/F", 
                                           ifelse(behavior %in% c("?", "FLYOVER"), NA, behavior))))) %>% 
    mutate(behavior = factor(behavior, levels = c("O", "F", "R", "R/F", ""))) %>% 
    
    # position/habitat
    mutate(position = tolower(position)) %>% 
    mutate(position = 
             ifelse(position %in% c("fv", "v,rs", "v/sw"), "v", 
                    ifelse(position %in% c("m/sw", "m, sw"), "m", 
                           ifelse(position %in% c("rs,sw,fw", "s", "r"), "rs", 
                                  ifelse(position %in% c("sw, m", "sw,m"), "sw", 
                                         ifelse(position %in% c("fw/v", "w", "fo"), "fw", 
                                                ifelse(position %in% c("?", "o", "fly over", "other"), NA, position))))))) %>% 
    
    # tide 
    mutate(tide_hl = gsub('"', "", tolower(tide_hl))) %>% 
    # mutate(tide_hl = factor(tide_hl, levels = "low", "mid", "high")) %>%
    
    # remove some funny data (TODO: check with Julia)
    subset(isle != "ROAMING" & isle != "*") %>% 
    
    # fill missing location data
    mutate(island = ifelse(tolower(isle) %in% c("as", "ac", "an"), "Aramburu", 
                           ifelse(tolower(isle) %in% c("p"), "Pickleweed", "Unnamed")))
  
  # Fill in Guild:
  # guilds of birds with no guild listed in data
  guild_lookup_list <- c("American Coot" = "water_fowl",
                         "American Crow" = "corvid", 
                         "American Robin" = "land_bird",
                         "American Wigeon" = "water_fowl",
                         "Bald Eagle" = "land_bird",
                         "Barn Swallow" = "land_bird",
                         "Belted Kingfisher" = "land_bird",
                         "Black Phoebe" = "land_bird",
                         "Brant" = "water_fowl",
                         "Brown Pelican" = "pelicaniformes",
                         "Bufflehead" = "water_fowl",
                         "Cackling Goose" = "water_fowl",
                         "Canada Goose" = "water_fowl",
                         "Canvasback" = "water_fowl",
                         "Cliff Swallow" = "land_bird",
                         "Common Goldeneye" = "water_fowl",
                         "Common Loon" = "water_fowl",
                         "Common Raven" = "corvid",
                         "Double-crested Cormorant" = "pelicaniformes",
                         "Gadwall" = "water_fowl",
                         "Greater Pewee" = "land_bird",
                         "Greater Scaup" = "water_fowl",
                         "Greater/Lesser Scaup" = "water_fowl",
                         "Green-winged Teal" = "water_fowl",
                         "Lesser Scaup" = "water_fowl",
                         "Loggerhead Shrike" = "land_bird",
                         "Mallard" = "water_fowl",
                         "Northern Flicker" = "land_bird",
                         "Northern Mockingbird" = "land_bird",
                         "Northern Pintail" = "water_fowl",
                         "Northern Shoveler" = "water_fowl",
                         "Osprey" = "land_bird",
                         "Pacific Loon" = "water_fowl",
                         "Pelagic Cormorant" = "pelicaniformes",
                         "Peregrine Falcon" = "land_bird",
                         "Red-breasted Merganser" = "water_fowl",
                         "Red-shouldered Hawk" = "land_bird",
                         "Red-tailed Hawk" = "land_bird",
                         "Red-throated Loon" = "water_fowl",
                         "Rock Pigeon" = "water_fowl",
                         "Ruddy Duck" = "water_fowl",
                         "Say's Phoebe" = "land_bird",
                         "Song Sparrow" = "land_bird",
                         "Surf Scoter" = "water_fowl",
                         "Turkey Vulture" = "land_bird",
                         # "Unidentifiable Bird" = "",
                         "Unidentifiable Cormorant" = "water_fowl",
                         "Unidentifiable Duck" = "water_fowl",
                         "Unidentifiable Loon" = "water_fowl",
                         "Western Bluebird" = "land_bird",
                         "Western Meadowlark" = "land_bird",
                         "Western Scrub-Jay" = "corvid",
                         "White-tailed Kite" = "land_bird")
  
  guild_lookup <- data.frame(common = names(guild_lookup_list), 
                             guild = as.vector(guild_lookup_list)) %>% 
    bind_rows(dat %>% 
                subset(!is.na(guild)) %>%
                distinct(common, guild)) %>% 
    rename(derived_guild = guild)
  
  dat <- dat %>%
    left_join(guild_lookup, by = "common") %>%
    mutate(new_guild = ifelse(is.na(guild), derived_guild, guild)) %>% 
    select(-guild, -derived_guild) %>% 
    rename(guild = new_guild)
  
  saveRDS(dat, "data/dat.rds")
} else {
  dat <- readRDS("data/dat.rds")  
}

dat %>% g
```

# Basic EDA

## Sampling Methods {.tabset}

Observations

- typically all chunks of the island were surveyed on every observation date
- typically measured at both high and low tide, sometimes only one. Occasionaly also "mid" tide.
- data spans 2009-2018, with 1-7 observations per month
- no obs in 1H 2009, 2H 2012, 2H 2015, and all of 2017

### per island

- Survey included all island areas virtually every time

```{r sampling-island}
dat %>% 
  group_by(obs_date, isle) %>% 
  summarize(n_sp = n()) %>% 
  mutate(has_count = !is.na(n_sp)) %>% 
  ggplot(aes(x = factor(obs_date), y = isle, fill = has_count)) +
  geom_raster() +
  scale_x_discrete(breaks = NULL) +
  medium_fonts +
  labs(x = "observation date", y = "island")
```

### per tide level

- tide_ft is usually NA
- usually birds were counted at both high and low tide, but not always 
- will need to control for tide later

```{r sampling-tide-1, include = F}
dat %>% 
  ggplot(aes(tide_ft)) + 
  geom_density(aes(fill = tide_hl), alpha = 0.8)
```


```{r sampling-tide-2}
dat %>% 
  group_by(obs_date, tide_hl) %>% 
  summarize(n_sp = n()) %>% 
  mutate(has_count = !is.na(n_sp)) %>% 
  ggplot(aes(x = factor(obs_date), y = tide_hl, fill = has_count)) +
  geom_raster() +
  scale_x_discrete(breaks = NULL) +
  medium_fonts +
  labs(x = "observation date", y = "tide")
```


### per month

- observations vary 1-7 per month
- missing data in 2017, 2H 2012, 2H 2015

```{r sampling-month}
dat %>% 
  select(isle, year, month_no, obs_date) %>% 
  distinct() %>% 
  group_by(isle, year, month_no) %>% 
  summarize(n_obs = n()) %>% 
  ungroup() %>%
  # complete missing observations:
  tidyr::spread(month_no, n_obs) %>% 
  tidyr::gather(month_no, n_obs, 3:15) %>% 
  mutate(has_count = !is.na(n_obs)) %>% 
  mutate(month_no = as.numeric(month_no)) %>% 
  subset(!is.na(month_no)) %>%
  ggplot(aes(x = month_no, y = year, fill = n_obs)) +
  geom_raster(aes(fill = n_obs)) +
  facet_wrap(~isle) +
  scale_x_continuous(breaks = seq(1,12)) +
  scale_y_continuous(breaks = seq(2009,2018)) +
  theme_bw() +
  labs(title = "Observations per Month")

```

# General Methods

## Data 

- File used: data/SHOREBIRD_DATA_Complete_2018.xls
- Data sampling dates ranged from Sept 2009 - July 2018
- Tide "high" vs. "low" was based on "HIGH/LOW" column in the spreadsheet.
- Construction epochs:
- Pre: Before 2011-09-01
- Construction: 2011-09-01 - 2012-09-01
- Post: After 2012-09-01
- Guilds: When not provided in the source data, birds were classified into guilds according to the following lookup:
- The only data excluded were those where isle was "roaming" and "*"

```
"American Coot" = "water_fowl",
"American Crow" = "corvid", 
"American Robin" = "land_bird",
"American Wigeon" = "water_fowl",
"Bald Eagle" = "land_bird",
"Barn Swallow" = "land_bird",
"Belted Kingfisher" = "land_bird",
"Black Phoebe" = "land_bird",
"Brant" = "water_fowl",
"Brown Pelican" = "pelicaniformes",
"Bufflehead" = "water_fowl",
"Cackling Goose" = "water_fowl",
"Canada Goose" = "water_fowl",
"Canvasback" = "water_fowl",
"Cliff Swallow" = "land_bird",
"Common Goldeneye" = "water_fowl",
"Common Loon" = "water_fowl",
"Common Raven" = "corvid",
"Double-crested Cormorant" = "pelicaniformes",
"Gadwall" = "water_fowl",
"Greater Pewee" = "land_bird",
"Greater Scaup" = "water_fowl",
"Greater/Lesser Scaup" = "water_fowl",
"Green-winged Teal" = "water_fowl",
"Lesser Scaup" = "water_fowl",
"Loggerhead Shrike" = "land_bird",
"Mallard" = "water_fowl",
"Northern Flicker" = "land_bird",
"Northern Mockingbird" = "land_bird",
"Northern Pintail" = "water_fowl",
"Northern Shoveler" = "water_fowl",
"Osprey" = "land_bird",
"Pacific Loon" = "water_fowl",
"Pelagic Cormorant" = "pelicaniformes",
"Peregrine Falcon" = "land_bird",
"Red-breasted Merganser" = "water_fowl",
"Red-shouldered Hawk" = "land_bird",
"Red-tailed Hawk" = "land_bird",
"Red-throated Loon" = "water_fowl",
"Rock Pigeon" = "water_fowl",
"Ruddy Duck" = "water_fowl",
"Say's Phoebe" = "land_bird",
"Song Sparrow" = "land_bird",
"Surf Scoter" = "water_fowl",
"Turkey Vulture" = "land_bird",
# "Unidentifiable Bird" = "",
"Unidentifiable Cormorant" = "water_fowl",
"Unidentifiable Duck" = "water_fowl",
"Unidentifiable Loon" = "water_fowl",
"Western Bluebird" = "land_bird",
"Western Meadowlark" = "land_bird",
"Western Scrub-Jay" = "corvid",
"White-tailed Kite" = "land_bird"
```

# Tide effects {.tabset}

## Number of Birds

There are more species observed at low tide than high tide, for all islands. This is consistent with known science. Yay. 

```{r tide-diffs}
# number of individuals per species, per date, isle, tide (grouped across observers, behaviors, positions, comments, etc.)
tide_qty_per_sp <- dat %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  group_by(obs_date, island, tide_hl, common) %>% 
  summarize(qty = sum(qty, na.rm = T))

tide_qty_per_sp %>% 
  group_by(obs_date, island, tide_hl) %>%
  summarize(n_species_observed = n()) %>%
  tidyr::spread(tide_hl, n_species_observed) %>% 
  mutate(difference = low-high) %>% 
  ggplot(aes(difference)) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_bar(alpha = 0.9) +
  facet_wrap(~island) +
  medium_fonts +
  labs(x = "difference", y = "number of sampling days", 
       title = "High vs. Low Tide difference in # species observed", 
       subtitle = "positive values: low tide has more species", 
       caption = "(paired comparison)")
```

## Species Presence

Species whose presence is significantly different between low & high tide.

**Methods:**
For each island, we counted the fraction of observation dates in which each species was present at high and low tide. We did not take into account how many individuals per species were present in this analysis. (So if we surveyed at high tide 50 times and found least sandpipers present 25 times at high tide, the fraction of dates in which least sandpipers were present at high tide would be 0.5.) To determine whether there was a significant difference in whether a species was present at high vs low tide we performed a two-sided test of equal proportions and selected species with significantly different frequencies at p<0.01 (chose p<0.01 instead of p<0.05 to mitigate the false positives we would expect from doing multiple comparisons, i.e. one for every species). The plot below shows the frequencies of species with significant differences at low and high tide. Species marked as "unidentified <sp>", e.g. "unidentified gull", were excluded from this analysis.

```{r tide-diffs-sig}
tide_qty <- tide_qty_per_sp %>% 
  subset(!grepl(pattern = "Unidentif", common)) %>%
  group_by(island, tide_hl, common) %>% 
  summarize(n_times_sp_observed = n()) %>% 
  # fill missing values with 0s:
  tidyr::spread(tide_hl, n_times_sp_observed) %>% # number times species was observed
  replace_na(list(high = 0, low = 0)) %>% 
  tidyr::gather(tide_hl, n_times_sp_observed, high, low) %>% 
  left_join(
    tide_qty_per_sp %>% 
      group_by(island, tide_hl) %>% 
      summarize(n_surveyed = length(unique(obs_date))),
    by = c("island", "tide_hl")
  ) 

tide_diffs <- tide_qty %>% 
  group_by(island, common) %>%
  arrange(tide_hl) %>% 
  do(tidy(prop.test(.$n_times_sp_observed, .$n_surveyed))) %>% 
  rename(high = estimate1,
         low = estimate2)  %>% 
  mutate(difference = low - high) # difference in whether bird was sighted on a survey between low & high tide
```

```{r tide-diffs-plot}
plot_dat <- tide_diffs %>% 
  subset(island == "Aramburu") %>%
  subset(!is.na(common)) %>% 
  subset(p.value < 0.01) %>% 
  select(island, common, low, high) %>% 
  mutate(difference = low-high) %>% 
  mutate(diff_type = ifelse(low > high, "more at low tide", "fewer at low tide")) %>% 
  tidyr::gather(tide_hl, frequency, low, high) %>% 
  mutate(tide_hl = factor(tide_hl, levels = c("low", "high"))) %>% 
  mutate(tide_hl_num = as.numeric(tide_hl)) 

plot_dat %>% 
  ggplot(aes(x = tide_hl_num, y = frequency)) +
  geom_line(aes(color = common)) +
  geom_point(aes(color = common), size = 3) +
  geom_text(data = subset(plot_dat, tide_hl_num == 1 ), 
            aes(label = common, color = common), 
            size =3, hjust = 1.15, fontface = "bold") +
  # geom_text(data = subset(plot_dat, tide_hl_num == 2 & diff_type == "fewer at low tide"), 
  #         aes(label = common, color = common), 
  #         size = 3, hjust = -0.15, fontface = "bold") +
  # geom_text(data = subset(plot_dat, tide_hl_num == 2), aes(label = common, color = common),
  #           size = 2, hjust = -0.15, fontface = "bold") +
  facet_wrap(~diff_type) + 
  medium_fonts +
  theme(strip.text.x = ggplot2::element_text(size = 10), 
        legend.position = "none") +
  scale_x_continuous(limits = c(-1, 2.5), breaks = c(1,2), labels = c("low", "high"), minor_breaks = NULL) +
  labs(x = "Tide", y = "Frequency of Sighting", 
       title = "Species with significantly different presence at low vs. high tide",
       subtitle = "Aramburu Island",
       caption = "only species with p < 0.01, chi-squared test")

```

```{r tide-diffs-plot-2}
plot_dat <- tide_diffs %>% 
  subset(island == "Pickleweed") %>%
  subset(!is.na(common)) %>% 
  subset(p.value < 0.01) %>% 
  select(island, common, low, high) %>% 
  mutate(difference = low-high) %>% 
  mutate(diff_type = ifelse(low > high, "more at low tide", "fewer at low tide")) %>% 
  tidyr::gather(tide_hl, frequency, low, high) %>% 
  mutate(tide_hl = factor(tide_hl, levels = c("low", "high"))) %>% 
  mutate(tide_hl_num = as.numeric(tide_hl)) 

plot_dat %>% 
  ggplot(aes(x = tide_hl_num, y = frequency)) +
  geom_line(aes(color = common)) +
  geom_point(aes(color = common), size = 3) +
  geom_text(data = subset(plot_dat, tide_hl_num == 1 ), 
            aes(label = common, color = common), 
            size =3, hjust = 1.15, fontface = "bold") +
  # geom_text(data = subset(plot_dat, tide_hl_num == 2 & diff_type == "fewer at low tide"), 
  #         aes(label = common, color = common), 
  #         size = 3, hjust = -0.15, fontface = "bold") +
  # geom_text(data = subset(plot_dat, tide_hl_num == 2), aes(label = common, color = common),
  #           size = 2, hjust = -0.15, fontface = "bold") +
  facet_wrap(~diff_type) + 
  medium_fonts +
  theme(strip.text.x = ggplot2::element_text(size = 10), 
        legend.position = "none") +
  scale_x_continuous(limits = c(-1.5, 2.5), breaks = c(1,2), labels = c("low", "high"), minor_breaks = NULL) +
  labs(x = "Tide", y = "Frequency of Sighting", 
       subtitle = "Pickleweed Island",
       title = "Species with significantly different presence at low vs. high tide",
       caption = "only species with p < 0.01, chi-squared test")

```

List birds sorted by difference in presence at high vs low tide.

```{r tide-diffs-list}
tide_diffs %>% 
  subset(island == "Aramburu") %>%
  subset(!is.na(common)) %>% 
  mutate(difference = low-high) %>% 
  select(island, common, low, high, difference, p.value) %>% 
  mutate(diff_type = ifelse(low > high, "more at low tide", "fewer at low tide")) %>% 
  arrange(desc(abs(difference)))
```

## Guild Presence

```{r guild-presence, echo = F}
tide_guild_qty <- dat %>%
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>%
  group_by(island, tide_hl, guild) %>%
  summarize(qty = sum(qty, na.rm = T))

# append n observed (not idempot.; need to run above lines first)
tide_guild_qty <- tide_guild_qty %>%
  left_join(tide_guild_qty %>%
              group_by(island, tide_hl) %>%
              summarize(total_observed = sum(qty)),
            by = c("island", "tide_hl")) %>%
  mutate(p_observed = qty/total_observed)


tide_guild_diffs <- tide_guild_qty %>%
  group_by(island, guild) %>%
  arrange(tide_hl) %>%
  do(tidy(prop.test(.$qty, .$total_observed))) %>%
  mutate(is_signif = p.value < 0.01) %>% 
  rename(high = estimate1,
         low = estimate2)  %>%
  mutate(difference = low - high) # difference in whether bird was sighted on a survey between low & high tide

tide_guild_diffs %>% g
```


```{r guild-plot}
plot_dat <- tide_guild_diffs %>% 
  tidyr::gather(tide_hl, proportion, low, high) %>% 
  mutate(tide_hl = factor(tide_hl, levels = c("low", "high"))) %>% 
  mutate(tide_hl_num = as.numeric(tide_hl)) 

plot_dat %>% 
  ggplot(aes(x = tide_hl_num, y = proportion)) +
  geom_line(aes(color = guild)) +
  geom_point(aes(color = guild), size = 3) +
  geom_text(data = subset(plot_dat, tide_hl_num == 1), aes(label = guild, color = guild), 
            size = 3, hjust = 1.15, fontface = "bold") +
  geom_text(data = subset(plot_dat, tide_hl_num == 2), aes(label = guild, color = guild), 
            size = 3, hjust = -0.15, fontface = "bold") +
  facet_wrap(~island) + 
  medium_fonts +
  theme(strip.text.x = ggplot2::element_text(size = 10), 
        legend.position = "none") +
  scale_x_continuous(limits = c(0.0, 3), breaks = c(1,2), labels = c("low", "high"), minor_breaks = NULL) +
  labs(x = "Tide", y = "Frequency Individual is Observed", 
       title = "Guild Representation at Low vs. High Tide", 
       caption = "All Guilds Shown")

plot_dat %>% 
  select(guild, difference, conf.low, conf.high) %>% 
  distinct() %>% # dedup bc each difference is in there twice
  ggplot(aes(x = reorder(guild, difference), y = difference)) +
  geom_bar(stat = "identity") + 
  geom_errorbar(aes(ymin = -conf.low, ymax = -conf.high), width = 0.2) +
  facet_wrap(~island) + 
  medium_fonts +
  coord_flip() +
  labs(x = "", y = "Difference (Low - High)", 
       title = "Difference in Guild Representation bet. Low & High Tide",
       subtitle = "Positive Values: more at low tide")
```


# Changes over time

Timeline

- fall 2011: shoreline enhancements
- summer 2012: wetland & terrestrial enhancements
- tldr:
- `before`: before fall 2011
- `construction`: fall 2011 - summer 2012 (??)
- `after`: after Sept 2012

From JK: "shoreline enhancement elements of the project were constructed in the fall of 2011, so I would say, starting January 2012, any data collected would be “post” construction.  The wetland and terrestrial enhancement elements on the island terrace were constructed in the summer of 2012. So there are sort of two “post” restoration periods. But because the shorebird surveys are only along the eastern shoreline, I would stick with Jan 2012 on as “post” restoration."


```{r sp-count-ts}
sp_count_island <- dat %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  group_by(obs_date, island, tide_hl, common) %>% 
  summarize(qty = sum(qty, na.rm = T)) %>% 
  mutate(species_observed_flag = ifelse(qty > 0, 1, 0)) %>% 
  group_by(obs_date, island, tide_hl) %>%
  summarize(n_species = sum(species_observed_flag),
            n_individuals = sum(qty)) %>% 
  ungroup() %>% 
  mutate(epoch = ifelse(obs_date < "2011-09-01", "before", 
                        ifelse(obs_date < "2012-09-01", "construction", "after"))) %>% 
  mutate(epoch = factor(epoch, levels = c("before", "construction", "after"))) %>% 
  mutate(month_no = factor(lubridate::month(obs_date)))

sp_count_isle <- dat %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  group_by(obs_date, isle, tide_hl, common) %>% 
  summarize(qty = sum(qty, na.rm = T)) %>% 
  mutate(species_observed_flag = ifelse(qty > 0, 1, 0)) %>% 
  group_by(obs_date, isle, tide_hl) %>%
  summarize(n_species = sum(species_observed_flag),
            n_individuals = sum(qty)) %>% 
  ungroup() %>% 
  mutate(epoch = ifelse(obs_date < "2011-09-01", "before", 
                        ifelse(obs_date < "2012-09-01", "construction", "after"))) %>% 
  mutate(epoch = factor(epoch, levels = c("before", "construction", "after"))) %>% 
  mutate(month_no = factor(lubridate::month(obs_date)))
```

## High-level ts {.tabset}

- all decreasing, esp since 2014
- Aramburu decreased less

### Species Count {.tabset}

#### by island
```{r sp-count-ts-plot}  
sp_count_island %>% 
  ggplot(aes(x = obs_date, y = n_species, group = tide_hl)) +
  geom_vline(xintercept = as.Date("2011-09-01")) +
  geom_vline(xintercept = as.Date("2012-09-01")) +
  geom_point(aes(color = tide_hl), size = 1, alpha = 0.8) +
  geom_smooth(aes(color = tide_hl, fill = tide_hl)) +
  # medium_fonts +
  theme_bw() +
  facet_wrap(~island) +
  labs(title = "Species Count")
```

#### by isle
```{r}
sp_count_isle %>% 
  subset(isle %in% c("AC", "AN", "AS")) %>% 
  ggplot(aes(x = obs_date, y = n_species, group = tide_hl)) +
  geom_vline(xintercept = as.Date("2011-09-01")) +
  geom_vline(xintercept = as.Date("2012-09-01")) +
  geom_point(aes(color = tide_hl), size = 1, alpha = 0.8) +
  geom_smooth(aes(color = tide_hl, fill = tide_hl)) +
  # medium_fonts +
  theme_bw() +
  facet_wrap(~isle) +
  labs(title = "Species Count")

sp_count_isle %>% 
  subset(isle %in% c("AC", "AN", "AS")) %>% 
  ggplot(aes(x = isle, y = n_species, group = isle)) +
  geom_boxplot() +
  medium_fonts +
  labs(x = "",
       y = "Number of Species Observed", 
       title = "Aramburu: Species Observed per Survey", 
       caption = "data 2009-2018")
```


### Individual Count {.tabset}

#### by island
```{r ind-count-ts-plot}
sp_count_island %>% 
  ggplot(aes(x = obs_date, y = n_individuals, group = tide_hl)) +
  geom_vline(xintercept = as.Date("2011-09-01")) +
  geom_vline(xintercept = as.Date("2012-09-01")) +
  geom_point(aes(color = tide_hl), size = 1, alpha = 0.8) +
  geom_smooth(aes(color = tide_hl, fill = tide_hl)) +
  # medium_fonts +
  theme_bw() +
  scale_y_log10(limits = c(NA, 2000)) +
  facet_wrap(~island) +
  labs(title = "Individual Count", y = "log10(n_individuals)")
```

#### by isle
```{r}
sp_count_isle %>% 
  subset(isle %in% c("AC", "AN", "AS")) %>% 
  ggplot(aes(x = obs_date, y = n_individuals, group = tide_hl)) +
  geom_vline(xintercept = as.Date("2011-09-01")) +
  geom_vline(xintercept = as.Date("2012-09-01")) +
  geom_point(aes(color = tide_hl), size = 1, alpha = 0.8) +
  geom_smooth(aes(color = tide_hl, fill = tide_hl)) +
  # medium_fonts +
  theme_bw() +
  scale_y_log10(limits = c(NA, 2000)) +
  facet_wrap(~isle) +
  labs(title = "Individual Count", y = "log10(n_individuals)")

sp_count_isle %>% 
  subset(isle %in% c("AC", "AN", "AS")) %>% 
  ggplot(aes(x = isle, y = n_individuals, group = isle)) +
  geom_boxplot() +
  # geom_density(aes(fill = isle), alpha = 0.8)+
  medium_fonts +
  scale_y_log10() +
  labs(x = "",
       y = "Number of Individuals Observed (log10)", 
       title = "Aramburu: Individuals Observed per Survey", 
       subtitle = "note log scale", caption = "data 2009-2018")
```

```{r sp-count-ts-samples, include = F, echo = F}
sp_count_island %>% 
  group_by(epoch) %>% 
  summarize(n_samples = length(unique(obs_date)))
```

## Aggregate Species Count

```{r sp-count-ts-hist}
sp_count_island %>% 
  subset(epoch %in% c("before", "after")) %>% 
  ggplot(aes(n_species, group = interaction(island, epoch, tide_hl))) +
  # geom_bar(aes(fill = epoch), position = "dodge") +
  geom_density(aes(fill = epoch), alpha = 0.6) +
  facet_grid(tide_hl~island) +
  scale_fill_manual(values = condition_colors) +
  theme_bw() +
  labs(title = "Species Count",
       x = "number of species observed")

# sp_count_island %>% 
#   subset(obs_date < as.Date("2017-01-01")) %>% 
#   subset(epoch %in% c("before", "after")) %>% 
#   ggplot(aes(n_species, group = interaction(island, epoch, tide_hl))) +
#   geom_density(aes(fill = epoch), position = "dodge", alpha = 0.6) +
#   facet_grid(tide_hl~island) +
#   scale_fill_manual(values = condition_colors) +
#   theme_bw() +
#   labs(title = "Species Count", subtitle = "Excludes data after 2017")
```

Fit lm to control for counfounding:
```{r sp-count-ts-lm}
sp_count_for_model <- sp_count_island %>% 
  subset(epoch %in% c("before", "after")) %>% 
  subset(!is.na(n_species))

lm_nsp <- lm(n_species ~ epoch 
             + island 
             + epoch:island 
             + tide_hl
             + month_no, 
             data = sp_count_for_model)

summary(lm_nsp)

sp_count_for_model$predict_n_species <- predict(lm_nsp)
```

Effect Size: 
```{r sp-count-ts-effect-size, echo=F}
sprintf("Aramburu has %2.2f more species vs. Pickleweed when comparing changes before vs. after restoration.", -lm_nsp$coefficients[["epochafter:islandPickleweed"]])

sprintf("Aramburu has %2.2f more species vs. Unnamed Island when comparing changes before vs. after restoration.", -lm_nsp$coefficients[["epochafter:islandUnnamed"]])
```


Sanity check w/ G-comp for treatement effect size. Result should be the same.
```{r sp-count-ts-gcomp}
delta_aramburu <- (mean(predict(lm_nsp, newdata = sp_count_for_model %>% 
                                  mutate(island = "Aramburu", 
                                         epoch = "after")))) - 
  (mean(predict(lm_nsp, newdata = sp_count_for_model %>% 
                  mutate(island = "Aramburu", 
                         epoch = "before")))) 

delta_pickleweed <- (mean(predict(lm_nsp, newdata = 
                                    sp_count_for_model %>% 
                                    mutate(island = "Pickleweed", 
                                           epoch = "after")))) -  #7.675406
  (mean(predict(lm_nsp, newdata = sp_count_for_model %>% 
                  mutate(island = "Pickleweed", 
                         epoch = "before")))) #9.424297

sprintf("G-comp estimate for Aramburu vs. Pickleweed: +%2.2f species", delta_aramburu - delta_pickleweed)

```


Sanity check predictions:
```{r sp-count-ts-prediction-plot}
sp_count_for_model %>% 
  group_by(island, tide_hl, epoch, month_no) %>% 
  summarize(mean_actual = mean(n_species),
            mean_predicted = mean(predict_n_species)) %>% 
  ggplot(aes(x = mean_actual, y = mean_predicted)) +
  geom_point(aes(color = island)) +
  geom_abline() 
```

## Individual Abundance
```{r indiv-count-ts}
sp_count_island %>% 
  subset(epoch %in% c("before", "after")) %>% 
  ggplot(aes(n_individuals, group = interaction(island, epoch, tide_hl))) +
  # geom_bar(aes(fill = epoch), position = "dodge") +
  geom_density(aes(fill = epoch), alpha = 0.6) +
  facet_grid(tide_hl~island) +
  scale_fill_manual(values = condition_colors) +
  scale_x_log10() +
  # xlim(0,1000) +
  theme_bw() +
  labs(title = "Individuals Count",
       x = "individuals observed",
       y = "log10(density)")
```

Fit lm to control for counfounding:
NB: log10!

```{r indiv-count-lm}
sp_abundance_for_model <- sp_count_island %>% 
  subset(epoch %in% c("before", "after")) %>% 
  subset(!is.na(n_individuals)) %>% 
  mutate(n_individuals_log10 = log10(n_individuals + 0.001)) %>% 
  mutate(log_0_flag = n_individuals == 0)

lm_nindiv <- lm(n_individuals_log10 ~  
                  + log_0_flag
                + island 
                + epoch:island 
                + tide_hl
                + month_no, 
                data = sp_abundance_for_model)

summary(lm_nindiv)

sp_abundance_for_model$predict_n_indiv <- predict(lm_nindiv)
```

Sanity check predictions:

```{r indiv-count-predict}
sp_abundance_for_model %>% 
  group_by(island, tide_hl, epoch, month_no) %>% 
  summarize(mean_actual = mean(n_individuals_log10),
            mean_predicted = mean(predict_n_indiv)) %>% 
  ggplot(aes(x = mean_actual, y = mean_predicted)) +
  geom_point(aes(color = island)) +
  geom_abline() 
```

## Indiv. Species 

Goal: Estimate the change in the average number of individuals of each species before vs. after construction. Above (Changes over time: `Species Count` and `Individual Count` sections) we saw an overall decline in the number of species and individuals of each species over the entire sampling period. The goal of this analysis is to estimate changes in species abundance (number of individuals), after we take into account the global downward trend. In other words, we can imagine that although the average number of individuals decreased, some species were relatively more abundand. Kind of like adjusting for inflation :) 

Conclusion: There really isn't enough data to make claims about individual species (the error bars on all of them are huge). That said, on average, there was a small decrease in the number of individuals after vs. before construction: about 0.5 individual birds per species fewer, on average, although this effect was not statistically significant (or "siggy" as my Marketing friends at work like to say). On top of this pattern some species showed different changes between the epochs. For example, there were significantly fewer coots after construction. There were more double-crested cormorants, scaup, and caspian terns.


Since we have a control island (Pickleweed), it's technically more correct to do a pair-wise comparison between observations on Ar and Pi. However, that would add even _more_ noise since we'd be combining noise across the two islands. Results would be even less significant and less interpretable.

- Construction epochs:
- Pre: Before 2011-09-01
- Construction: 2011-09-01 - 2012-09-01
- Post: After 2012-09-01

### Methods

For each island, we counted the number of individuals present of each species at high and low tide (separately) on each survey date. To account for the global decrease in abundance as well as confounders such as season we fitted a linear model to the species counts. The model was of the form:

`number_of_individuals = species_name + month + tide_high_low + epoch + epoch_x_species_name`.

Here's what we're doing, starting with the most boring terms and ending with the most interesting:
- `species_name` is an indicator of species name, thus it lets the model estimates the marginal (i.e. accounting for all other things) average number of individuals of each species (e.g. there are more gulls than rails, so you need to account for that). This controls for differences between species. There's a value for every species, so no listing them here.
- `month`: controls for seasonal differences
- `tide_high_low`: controls for tide differences, which we know there are!
- `epoch`: main effect of time -- estimates the average difference in individuals before and after construction. The coefficient on `epoch = after` on Aramburu was -0.5, meaning that there were about 0.5 fewer individuals per species after construction, on average. This effect was not statistically significant, but we can see in the plot of indivudals over time (above) that the trend appears to be real. Note I chose to bin the data into epochs rather then using a continuous feature like `year` because the changes were not linear over time and I wanted more statistical power from binning. 
- `epoch_x_species_name`: the interaction between epoch and species. In other words, after accounting for the overall change among all species (with `epoch`), how did each species change before vs. after construction? This is what's plotted below, and error bars are 95% confidence intervals on those estimates. I wouldn't try to directly interpret the numbers on the x axis, interaction terms are weird.



Alex notes to self:
- Fit model; Aramburu only. 
- Significant interactions between epoch and species means that there was a significant change.
- Not really enough data to talk about individual species.
- NB this is a lower bound on variance, we should really be comparing to Pickleweed or Unnamed, in which case the variance here would be added to the variance of Pickleweed or Unnamed Island 

### Aramburu
```{r indiv-sp-count-lm}
# library(lme4) # not used

tide_qty_per_sp_ar <- dat %>% 
  # choose only Aramburu birds
  subset(island == "Aramburu") %>% 
  subset(epoch %in% c("before", "after")) %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  subset(!grepl(pattern = "Unidentif", x = common)) %>% 
  # summarize to get total quantity of a species
  group_by(obs_date, island, epoch, tide_hl, common) %>% 
  summarize(qty = sum(qty, na.rm = T)) %>% 
  mutate(month_no = factor(lubridate::month(obs_date)))

lm_nind <- lm(qty ~ 
                + epoch
              + common
              + month_no
              + tide_hl
              + epoch:common
              # + (1 | common) # ICC = .10 w/ lmer
              , 
              data = tide_qty_per_sp_ar)

# summary(lm_nind)

nind_coeff <- broom::tidy(lm_nind) 
```
```{r}
nind_coeff
```


```{r indiv-sp-count-plot, fig.height = 6, fig.width=6}
nind_coeff %>% 
  subset(grepl("epochafter:common", term)) %>% 
  mutate(species = gsub("epochafter:common", "", term)) %>% 
  # arrange(estimate) %>% 
  ggplot(aes(x = reorder(species, estimate), y = estimate)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = estimate - 1.96*std.error, ymax = estimate + 1.96*std.error)) +
  coord_flip() +
  theme_bw() + 
  labs(x = "", y = "", 
       title = "Aramburu: Individuals of each species after vs. before improvements",
       subtitle = "positive values: more individuals after improvements")
```

### Pickleweed

Same analysis but for Pi.

```{r indiv-sp-count-lm-pi}
# library(lme4) # not used

tide_qty_per_sp_pi <- dat %>% 
  subset(island == "Pickleweed") %>% 
  subset(epoch %in% c("before", "after")) %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  subset(!grepl(pattern = "Unidentif", x = common)) %>% 
  # summarize to get total quantity of a species
  group_by(obs_date, island, epoch, tide_hl, common) %>% 
  summarize(qty = sum(qty, na.rm = T)) %>% 
  mutate(month_no = factor(lubridate::month(obs_date)))

lm_nind_pi <- lm(qty ~ 
                   + epoch
                 + common
                 + month_no
                 + tide_hl
                 + epoch:common
                 # + (1 | common) # ICC = .10 w/ lmer
                 , 
                 data = tide_qty_per_sp_pi)

# summary(lm_nind)

nind_coeff_pi <- broom::tidy(lm_nind_pi) 
```

```{r}
nind_coeff_pi
```


```{r indiv-sp-count-plot-pi, fig.height = 6, fig.width=6}
nind_coeff_pi %>% 
  subset(grepl("epochafter:common", term)) %>% 
  mutate(species = gsub("epochafter:common", "", term)) %>% 
  # arrange(estimate) %>% 
  ggplot(aes(x = reorder(species, estimate), y = estimate)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = estimate - 1.96*std.error, ymax = estimate + 1.96*std.error)) +
  coord_flip() +
  theme_bw() + 
  labs(x = "", y = "", 
       title = "Pickleweed: Individuals of each species after vs. before improvements",
       subtitle = "positive values: more individuals after improvements")
```

## Guilds

### Methods
Same analysis as for individuals above, but grouped at the guild level to get more statistical power.

Conclusion: Data is also too noisy to see real changes on the guild level too. It does look like Aramburu had more gulls after construction and fewer water fowl. Pickleweed also saw an increase in gulls (directionally, but not signif.)

### Aramburu

```{r guild-count-lm}
# library(lme4) # not used

# number of individuals per species, per date, isle, tide (grouped across observers, behaviors, positions, comments, etc.)
tide_qty_per_guild_ar <- dat %>% 
  # choose only Aramburu birds
  subset(island == "Aramburu") %>% 
  subset(epoch %in% c("before", "after")) %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  # summarize to get total quantity of a species
  group_by(obs_date, island, epoch, tide_hl, guild) %>% 
  summarize(qty = sum(qty, na.rm = T)) %>% 
  mutate(month_no = factor(lubridate::month(obs_date)))

lm_nguild <- lm(qty ~ 
                  + epoch
                + guild
                + month_no
                + tide_hl
                + epoch:guild
                # + (1 | common) # ICC = .10 w/ lmer; not used
                , 
                data = tide_qty_per_guild_ar)

# summary(lm_nind)

nguild_coeff <- broom::tidy(lm_nguild) 
```


```{r guild-count-plot}
nguild_coeff %>% 
  subset(grepl("epochafter:guild", term)) %>% 
  mutate(guild = gsub("epochafter:guild", "", term)) %>% 
  # arrange(estimate) %>% 
  ggplot(aes(x = reorder(guild, estimate), y = estimate)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = estimate - 1.96*std.error, ymax = estimate + 1.96*std.error), width = 0.2) +
  # coord_flip() +
  theme_bw() + 
  labs(x = "", y = "", 
       title = "Aramburu: Individuals of each guild after vs. before improvements",
       subtitle = "positive values: more individuals after improvements")
```

### Pickleweed


```{r guild-count-lm-pi}
# library(lme4) # not used

# number of individuals per species, per date, isle, tide (grouped across observers, behaviors, positions, comments, etc.)
tide_qty_per_guild_pi <- dat %>% 
  subset(island == "Pickleweed") %>% 
  subset(epoch %in% c("before", "after")) %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  # summarize to get total quantity of a species
  group_by(obs_date, island, epoch, tide_hl, guild) %>% 
  summarize(qty = sum(qty, na.rm = T)) %>% 
  mutate(month_no = factor(lubridate::month(obs_date)))

lm_nguild_pi <- lm(qty ~ 
                     + epoch
                   + guild
                   + month_no
                   + tide_hl
                   + epoch:guild
                   # + (1 | common) # ICC = .10 w/ lmer; not used
                   , 
                   data = tide_qty_per_guild_pi)

# summary(lm_nind)

nguild_coeff_pi <- broom::tidy(lm_nguild_pi) 
```


```{r guild-count-plot-pi}
nguild_coeff_pi %>% 
  subset(grepl("epochafter:guild", term)) %>% 
  mutate(guild = gsub("epochafter:guild", "", term)) %>% 
  # arrange(estimate) %>% 
  ggplot(aes(x = reorder(guild, estimate), y = estimate)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = estimate - 1.96*std.error, ymax = estimate + 1.96*std.error), width = 0.2) +
  # coord_flip() +
  theme_bw() + 
  labs(x = "", y = "", 
       title = "Pickleweed: Individuals of each guild after vs. before improvements",
       subtitle = "positive values: more individuals after improvements")
```

# Behaviors
```{r}
behaviors <- dat %>% 
  # choose only Aramburu birds
  subset(island == "Aramburu") %>% 
  subset(epoch %in% c("before", "after")) %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  # summarize to get total quantity of a species
  group_by(obs_date, island, epoch, tide_hl, common, behavior) %>% 
  summarize(qty = sum(qty, na.rm = T)) %>% 
  mutate(month_no = factor(lubridate::month(obs_date)))

lm_behav <- lm(qty ~ 
                 + epoch
               + behavior
               + month_no
               + tide_hl
               # + common
               + epoch:behavior
               # + (1 | common) # ICC = .10 w/ lmer
               , 
               data = behaviors)

behav_coeff <- broom::tidy(lm_behav) 

# summary(lm_behav)
```

## Change w/ construction

Was there a significant difference in the number of individuals spending time on each behavaior before vs. after construction? No.

```{r}
behav_coeff %>% 
  subset(grepl("epochafter:behavior", term)) %>% 
  mutate(behavior = tolower(gsub("epochafter:behavior", "", term))) %>% 
  left_join(behavior_key, by = c("behavior" = "short_name")) %>% 
  ggplot(aes(x = reorder(long_name, estimate), y = estimate)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = estimate - 1.96*std.error, ymax = estimate + 1.96*std.error), width = 0.2) +
  geom_label(aes(label =  sprintf("%2.2f", estimate))) +
  theme_bw() + 
  labs(x = "", y = "", 
       title = "Aramburu: Behavior after vs. before improvements",
       subtitle = "positive values: more of the behavior after improvements")
```

## Behavior Frequency by Guild

```{r}
behaviors_guild <- dat %>% 
  subset(island %in% c("Aramburu", "Pickleweed")) %>% 
  subset(epoch %in% c("after")) %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  mutate(behavior = as.character(behavior)) %>%
  mutate(behavior_long = 
           ifelse(behavior == "O", "Other", 
                  ifelse(behavior == "F", "Foraging", 
                         ifelse(behavior == "R", "Roosting", 
                                ifelse(behavior == "R/F", "Roosting/Foraging", "Unlabeled"))))) %>% 
  mutate(behavior_long = ifelse(is.na(behavior_long), "Unlabeled", behavior_long)) %>% 
  mutate(behavior_long = factor(behavior_long, levels = c("Roosting", "Foraging", "Roosting/Foraging", "Other", "Unlabeled"))) %>% 
# summarize to get total quantity of a species
group_by(island, guild, behavior_long
         ) %>% 
  summarize(qty = sum(qty, na.rm = T))  %>% 
  mutate(p = qty/sum(qty))

# behaviors_guild
```

```{r}
behavior_colors <- brewer.pal(length(behaviors_guild$behavior_long %>% unique()), "Set2")
names(behavior_colors) <- levels(behaviors_guild$behavior_long)
behaviors_fill_scale <- scale_fill_manual(name = "Behaviors", values = behavior_colors)
```


**Methods:**
For all sampling dates after construction (after 2012-09-01), at both high and low tide, add up the number of individuals per guild observed doing each behavior. Then, plot what fraction of individuals per guild were doing each behavior:


```{r}
behaviors_guild %>% 
  subset(!is.na(guild)) %>% 
  # subset(island == "Aramburu") %>% 
  ggplot(aes(x = reorder(guild, p), y = p, fill = behavior_long)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_grid(island~.) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1), legend.title=element_blank()) +
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "", y = "", title = "Percent of Individuals Performing Each Behavior") 

# behaviors_guild %>% 
#   subset(!is.na(guild)) %>% 
#   subset(island == "Pickleweed") %>% 
#   ggplot(aes(x = reorder(guild, p), y = p, fill = behavior_long)) +
#   geom_bar(stat = "identity", position = "stack") +
#   # facet_grid(island~.) + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
#   labs(x = "", y = "", title = "Pickleweed: Fraction of Guild Time Spent on Each Behavior") 
```

## Behavior breakdown by species {.tabset}

**Methods:**
For all sampling dates after construction (after 2012-09-01), at both high and low tide, add up the number of individuals per species observed doing each behavior. Then, plot what fraction of individuals per species were doing each behavior:

```{r}
behaviors_sp <- dat %>% 
  subset(island %in% c("Aramburu", "Pickleweed")) %>% 
  subset(epoch %in% c("after")) %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  mutate(behavior = as.character(behavior)) %>%
  mutate(behavior_long = 
           ifelse(behavior == "O", "Other", 
                  ifelse(behavior == "F", "Foraging", 
                         ifelse(behavior == "R", "Roosting", 
                                ifelse(behavior == "R/F", "Roosting/Foraging", "Unlabeled"))))) %>% 
  mutate(behavior_long = ifelse(is.na(behavior_long), "Unlabeled", behavior_long)) %>%
 mutate(behavior_long = factor(behavior_long, levels = c("Roosting", "Foraging", "Roosting/Foraging", "Other", "Unlabeled"))) %>% 

# summarize to get total quantity of a species
group_by(island, guild, common, behavior_long
         ) %>% 
  summarize(qty = sum(qty, na.rm = T))  %>% 
  mutate(p_sp = qty/sum(qty),
         p_guild = p_sp/sum(sum(qty)))

# # Save to CSV
behaviors_sp %>%
  write.csv("data/behaviors_sp.csv")

```

### corvid
```{r}
behaviors_sp %>% subset(!is.na(guild)) %>% 
  subset(island == "Aramburu") %>%
  subset(guild == "corvid") %>%
  ggplot(aes(x = common, y = p_sp, fill = behavior_long)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ guild) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  behaviors_fill_scale + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "", y = "", title = "Time Spent on Each Behavior") 
```
### grebes
```{r}
behaviors_sp %>% subset(!is.na(guild)) %>% 
  subset(!grepl("Unidentif", common)) %>% 
  subset(island == "Aramburu") %>%
  subset(guild == "grebes") %>%
  ggplot(aes(x = common, y = p_sp, fill = behavior_long)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ guild) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  behaviors_fill_scale + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "", y = "", title = "Time Spent on Each Behavior") 
```

### gulls
```{r}
behaviors_sp %>% subset(!is.na(guild)) %>%
  subset(!grepl("Unidentif", common)) %>% 
  subset(island == "Aramburu") %>%
  subset(guild == "gulls") %>%
  ggplot(aes(x = common, y = p_sp, fill = behavior_long)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ guild) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  behaviors_fill_scale + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "", y = "", title = "Time Spent on Each Behavior") 
```

### land birds
```{r}
behaviors_sp %>% subset(!is.na(guild)) %>% 
  subset(!grepl("Unidentif", common)) %>% 
  subset(island == "Aramburu") %>%
  subset(guild == "land_bird") %>%
  ggplot(aes(x = common, y = p_sp, fill = behavior_long)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ guild) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  behaviors_fill_scale + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "", y = "", title = "Time Spent on Each Behavior") 
```

### shorebirds
```{r}
behaviors_sp %>% subset(!is.na(guild)) %>% 
  subset(island == "Aramburu") %>%
  subset(guild == "shorebirds") %>%
  subset(!grepl("Unidentif", common)) %>% 
  ggplot(aes(x = common, y = p_sp, fill = behavior_long)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ guild) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  behaviors_fill_scale + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "", y = "", title = "Time Spent on Each Behavior") 
```

### water fowl
```{r}
behaviors_sp %>% subset(!is.na(guild)) %>% 
  subset(!(common %in% "Rock Pigeon")) %>% 
  subset(island == "Aramburu") %>%
  subset(guild == "water_fowl") %>%
  subset(!grepl("Unidentif", common)) %>% 
  ggplot(aes(x = common, y = p_sp, fill = behavior_long)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ guild) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  behaviors_fill_scale + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "", y = "", title = "Time Spent on Each Behavior") 
```

### wading
```{r}
behaviors_sp %>% subset(!is.na(guild)) %>% 
  subset(island == "Aramburu") %>%
  subset(guild == "wading") %>%
  subset(!grepl("Unidentif", common)) %>% 
  ggplot(aes(x = common, y = p_sp, fill = behavior_long)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ guild) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  behaviors_fill_scale + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "", y = "", title = "Time Spent on Each Behavior") 
```

### pelicaniformes
```{r}
behaviors_sp %>% subset(!is.na(guild)) %>% 
  subset(island == "Aramburu") %>%
  subset(guild == "pelicaniformes") %>%
  subset(!grepl("Unidentif", common)) %>% 
  ggplot(aes(x = common, y = p_sp, fill = behavior_long)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ guild) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  behaviors_fill_scale + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "", y = "", title = "Time Spent on Each Behavior") 
```

### terns
```{r}
behaviors_sp %>% subset(!is.na(guild)) %>% 
  subset(island == "Aramburu") %>%
  subset(guild == "terns") %>%
  subset(!grepl("Unidentif", common)) %>% 
  ggplot(aes(x = common, y = p_sp, fill = behavior_long)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~ guild) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  behaviors_fill_scale + 
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "", y = "", title = "Time Spent on Each Behavior") 
```


## Habitats
```{r}
# fraction of each guild that's on a particular habitat, per island per year
habitats <- dat %>% 
  group_by(island, year, guild, position) %>% 
  summarize(qty = sum(qty)) %>% 
  mutate(p_guild = qty/sum(qty)) %>% 
  ungroup() %>% 
  left_join(position_key, by = c("position" = "short_name"))

```

```{r fig.width = 6, fig.height = 6}
habitats %>% 
  subset(island != "Unnamed") %>% 
  subset(!is.na(guild)) %>% 
  subset(!is.na(long_name)) %>% 
  tidyr::spread(long_name, p_guild) %>%
  tidyr::gather(long_name, p_guild, -island, -year, -guild, -position, -qty) %>% 
  replace_na(list(p_guild = 0)) %>% 
  ggplot(aes(x = year, y = p_guild, fill = long_name, color = long_name)) +
  geom_bar(stat = "identity", position = "stack") +
  # geom_area(position = "stack") +
  # geom_line() +
  facet_grid(guild~island) +
  theme(legend.position = "right") + 
  medium_fonts +
  scale_y_continuous(breaks = c(0,1)) +
  labs(title = "Habitat Choices Over Time", x = "Year", y = "Fraction of Guild on Habitat")
```

```{r fig.width = 6, fig.height = 6}
dat %>% 
  subset(year >= 2013) %>% 
  subset(!(guild %in% c("gulls", "pelicaniformes"))) %>% # missing some data?
  group_by(island, guild, position) %>% 
  summarize(qty = sum(qty)) %>% 
  mutate(p_guild = qty/sum(qty)) %>% 
  ungroup() %>% 
  left_join(position_key, by = c("position" = "short_name")) %>% 
  subset(island != "Unnamed") %>% 
  subset(!is.na(guild)) %>% 
  subset(!is.na(long_name)) %>% 
  tidyr::spread(long_name, p_guild) %>%
  tidyr::gather(long_name, p_guild, -island, -guild, -position, -qty) %>% 
  replace_na(list(p_guild = 0)) %>% 
  ggplot(aes(x = island, y = p_guild, fill = long_name, color = long_name)) +
  geom_bar(stat = "identity", position = "stack") +
  # geom_area(position = "stack") +
  # geom_line() +
  facet_grid(guild~.) +
  theme(legend.position = "right") + 
  medium_fonts+
  # theme(plot.margin=unit(c(1, 20, 0.5, 0.5), "lines"))
  labs(title = "Habitat Choices", subtitle = "Since", x = "", y = "Fraction of Guild on Habitat")

# dat %>% 
#   subset(year >= 2013) %>% 
#   subset(!(guild %in% c("gulls", "pelicaniformes"))) %>% # missing some data?
#   group_by(island, guild, position) %>% 
#   summarize(qty = sum(qty)) %>% 
#   mutate(p_guild = qty/sum(qty)) %>% 
#   ungroup() %>% 
#   left_join(position_key, by = c("position" = "short_name")) %>% 
#   subset(island != "Unnamed") %>% 
#   subset(!is.na(guild)) %>% 
#   subset(!is.na(long_name)) %>% 
#   tidyr::spread(long_name, p_guild) %>%
#   tidyr::gather(long_name, p_guild, -island, -guild, -position, -qty) %>% 
#   replace_na(list(p_guild = 0)) %>% 
#   mutate(island = factor(island, levels = c("Aramburu", "Pickleweed"))) %>% 
#   mutate(island_num = as.numeric(island)) %>% 
#   
#   ggplot(aes(x = island_num, y = p_guild, fill = long_name, color = long_name)) +
#   # geom_bar(stat = "identity", position = "stack") +
#   # geom_area(position = "stack") +
#   geom_line() +
#   facet_grid(guild~.) +
#   theme(legend.position = "right") + 
#   medium_fonts+
#   # theme(plot.margin=unit(c(1, 20, 0.5, 0.5), "lines"))
#   labs(title = "Habitat Choices Since 2013", x = "", y = "Fraction of Guild on Habitat")
```

# Island Species Compare: Ar vs Pi

The goal here to ask, are some species more frequently observed on Ar vs Pi? We do this separately before and after construction/restoration.

Here we're back to comparing "what fraction of the time was the species seen?" and _not_ talking about the number of individuals of each species. We get the average fraction of the time a species was observed (`# times observed`/`# surveys`) and do a proportions test to see if the difference between islands is significant. By combining across observation dates we get more statistical power than e.g. in the individual counts plot above ("Individ. Species"). I do the analysis separately for high and low tide, the differences shown are for low tide only.

The x-axis is interpretable and can be read as the difference in frequency of sightings between Ar and P

Conclusion: After construction Aramburu hosts more crows, cormorants, oystercatchers, ravens, buffleheads, scaup, canada goose, and others. Notably, there are now a lot more oystercathcers on Aramburu vs Pickleweed than there were before the cosntruction. 


## After Construction
```{r island-diffs-sig}
# this is exactly the same as "tide_qty" above
island_qty_after <- tide_qty_per_sp %>% 
  subset(obs_date > as.Date("2012-09-01")) %>% 
  subset(island %in% c("Aramburu", "Pickleweed")) %>% 
  group_by(island, tide_hl, common) %>% 
  summarize(n_times_sp_observed = n()) %>% 
  # fill missing values with 0s:
  tidyr::spread(tide_hl, n_times_sp_observed) %>% # number times species was observed
  replace_na(list(high = 0, low = 0)) %>% 
  tidyr::gather(tide_hl, n_times_sp_observed, high, low) %>% 
  left_join(
    tide_qty_per_sp %>% 
      group_by(island, tide_hl) %>% 
      summarize(n_surveyed = length(unique(obs_date))),
    by = c("island", "tide_hl")
  ) 

island_diffs_after <- island_qty_after %>% 
  group_by(tide_hl, common) %>%
  arrange(island) %>% 
  do(tidy(prop.test(.$n_times_sp_observed, .$n_surveyed))) %>% 
  rename(Aramburu = estimate1,
         Pickleweed = estimate2)  %>%
  mutate(difference = Aramburu - Pickleweed) # difference in whether bird was sighted on a survey between low & high tide
```

```{r island-diffs-plot, fig.width=7, fig.height=7}
island_diffs_after %>% 
  subset(!grepl("Unident", common)) %>% 
  subset(tide_hl == "low") %>% 
  subset(!is.na(difference)) %>%
  subset(!is.na(common)) %>% 
  ggplot(aes(x = reorder(common, difference), y = difference)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  coord_flip() +
  theme_bw() +
  # medium_fonts + 
  labs(x = "", y = "More at Pickleweed ←                → More at Aramburu" ,       
       title = "Difference in Frequency of Species Observation After Construction",
       subtitle = "Positive Values: more at Aramburu",
       caption = "data Oct 2012 - Jul 2018")

island_diffs_after %>% 
  subset(!grepl("Unident", common)) %>% 
  subset(tide_hl == "low") %>% 
  subset(!is.na(difference)) %>%
  subset(!is.na(common)) %>% 
  ggplot(aes(x = reorder(common, difference), y = difference)) +
  geom_bar(stat = "identity") +
  # geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  coord_flip() +
  theme_bw() +
  # medium_fonts + 
  labs(x = "", y = "More at Pickleweed ←                → More at Aramburu" ,       
       title = "Difference in Frequency of Species Observation After Construction" ,
       subtitle = "Positive Values: more at Aramburu",
       caption = "data Oct 2012 - Jul 2018")

```

## Before Construction
```{r island-diffs-sig-before}
# this is exactly the same as "tide_qty" above
island_qty_before <- tide_qty_per_sp %>% 
  subset(obs_date < as.Date("2011-09-01")) %>% 
  subset(island %in% c("Aramburu", "Pickleweed")) %>% 
  group_by(island, tide_hl, common) %>% 
  summarize(n_times_sp_observed = n()) %>% 
  # fill missing values with 0s:
  tidyr::spread(tide_hl, n_times_sp_observed) %>% # number times species was observed
  replace_na(list(high = 0, low = 0)) %>% 
  tidyr::gather(tide_hl, n_times_sp_observed, high, low) %>% 
  left_join(
    tide_qty_per_sp %>% 
      group_by(island, tide_hl) %>% 
      summarize(n_surveyed = length(unique(obs_date))),
    by = c("island", "tide_hl")
  ) 

island_diffs_before <- island_qty_before %>% 
  group_by(tide_hl, common) %>%
  arrange(island) %>% 
  do(tidy(prop.test(.$n_times_sp_observed, .$n_surveyed))) %>% 
  rename(Aramburu = estimate1,
         Pickleweed = estimate2)  %>%
  mutate(difference = Aramburu - Pickleweed) # difference in whether bird was sighted on a survey between low & high tide
```

```{r island-diffs-plot-before, fig.width=7, fig.height=7}
island_diffs_before %>% 
  subset(!grepl("Unident", common)) %>% 
  subset(tide_hl == "low") %>% 
  subset(!is.na(difference)) %>%
  subset(!is.na(common)) %>% 
  ggplot(aes(x = reorder(common, difference), y = difference)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  coord_flip() +
  theme_bw() +
  # medium_fonts + 
  labs(x = "", y = "More at Pickleweed ←                → More at Aramburu" ,       
       title = "Difference in Frequency of Species Observation Before Construction",
       subtitle = "Positive Values: more at Aramburu",
       caption = "data Sep 2009 - Sep 2011")

island_diffs_before %>% 
  subset(!grepl("Unident", common)) %>% 
  subset(tide_hl == "low") %>% 
  subset(!is.na(difference)) %>%
  subset(!is.na(common)) %>% 
  ggplot(aes(x = reorder(common, difference), y = difference)) +
  geom_bar(stat = "identity") +
  # geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  coord_flip() +
  theme_bw() +
  # medium_fonts + 
  labs(x = "", y = "More at Pickleweed ←                → More at Aramburu" ,       
       title = "Difference in Frequency of Species Observation Before Construction",
       subtitle = "Positive Values: more at Aramburu",
       caption = "data Sep 2009 - Sep 2011")

```

# Focal Species

## Aramburu
```{r}
focal_species <- c("American Wigeon", "Caspian Tern", "Elegant Tern", "Least Sandpiper", "Spotted Sandpiper", "Marbled Godwit", "Long-billed Curlew", "Black-necked Stilt", "American Coot", "Double-crested Cormorant", "Black Oystercatcher")

focal_counts <- dat %>% 
  # choose only Aramburu
  subset(island == "Aramburu") %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(!grepl(pattern = "Unidentif", x = common)) %>% 
  select(obs_date, island, tide_hl,common, qty
         # isle, position
  ) %>% 
  group_by(obs_date, island, common) %>% 
  summarize(qty = sum(qty, na.rm = T)) %>% 
  ungroup() %>% 
  tidyr::spread(common, qty) %>% 
  tidyr::gather(common, qty, -obs_date, -island) %>% 
  replace_na(list(qty = 0)) %>% 
  mutate(was_observed = ifelse(qty>0,1,0)) %>% 
  mutate(n_observed_w_nulls = ifelse(qty>0, qty, NA)) %>% 
  mutate(year_no = lubridate::year(obs_date)) %>% 
  group_by(year_no, island, common) %>% 
  summarize(p_present = mean(was_observed),
            n_present = mean(n_observed_w_nulls, na.rm = T)) %>% 
  subset(common %in% focal_species) 
```

### frequency of sightings

**Methods:**
For each island, compute the fracton of surveys each year (both at high and low tide) in which any number of each species was present.

```{r}
focal_counts %>% 
  ggplot(aes(x = year_no, y = p_present, color = common)) +
  geom_line(color = "black") +
  geom_point(color = "black") +
  facet_wrap(~common) + 
  theme_bw() +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "Year", y = "", title = "Aramburu: Species Presence")
```



### total number of individuals

**Methods:**
For each island, compute average number of individuals present per year. Only count individuals when the species was observed (i.e. do not average in 0s)

```{r}
focal_counts %>% 
  ggplot(aes(x = year_no, y = n_present, color = common)) +
  geom_line(color = "black") +
  geom_point(color = "black") +
  facet_wrap(~common, scales = "free_y") + 
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "Year", y = "number of individuals", title = "Aramburu: Average Number of Individuals Present")
```

## Pickleweed
```{r}
focal_species <- c("American Wigeon", "Caspian Tern", "Elegant Tern", "Least Sandpiper", "Spotted Sandpiper", "Marbled Godwit", "Long-billed Curlew", "Black-necked Stilt", "American Coot", "Double-crested Cormorant", "Black Oystercatcher")

focal_counts_pi <- dat %>% 
  subset(island == "Pickleweed") %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(!grepl(pattern = "Unidentif", x = common)) %>% 
  select(obs_date, island, tide_hl,common, qty
         # isle, position
  ) %>% 
  group_by(obs_date, island, common) %>% 
  summarize(qty = sum(qty, na.rm = T)) %>% 
  ungroup() %>% 
  tidyr::spread(common, qty) %>% 
  tidyr::gather(common, qty, -obs_date, -island) %>% 
  replace_na(list(qty = 0)) %>% 
  mutate(was_observed = ifelse(qty>0,1,0)) %>% 
  mutate(n_observed_w_nulls = ifelse(qty>0, qty, NA)) %>% 
  mutate(year_no = lubridate::year(obs_date)) %>% 
  group_by(year_no, island, common) %>% 
  summarize(p_present = mean(was_observed),
            n_present = mean(n_observed_w_nulls, na.rm = T)) %>% 
  subset(common %in% focal_species) 
```

### frequency of sightings

```{r}
focal_counts_pi %>% 
  ggplot(aes(x = year_no, y = p_present, color = common)) +
  geom_line(color = "black") +
  geom_point(color = "black") +
  facet_wrap(~common) + 
  theme_bw() +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::percent) + 
  labs(x = "Year", y = "", title = "Pickleweed: Frequency of Each Species Being Present")
```

### total number of individuals
```{r}
focal_counts_pi %>% 
  ggplot(aes(x = year_no, y = n_present, color = common)) +
  geom_line(color = "black") +
  geom_point(color = "black") +
  facet_wrap(~common, scales = "free_y") + 
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "Year", y = "", title = "Pickleweed: Average Number of Individuals Present")
```

# Habitat
```{r}
focal_species_habitat <- dat %>% 
  # choose only Aramburu
  subset(island == "Aramburu") %>% 
  subset(epoch %in% c("before", "after")) %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(!grepl(pattern = "Unidentif", x = common)) %>% 
  subset(tide_hl == "low") %>% 
  select(epoch, island, position, common, qty
         # isle, position
  ) %>% 
  group_by(epoch, island, position, common) %>% 
  summarize(qty = sum(qty, na.rm = T)) %>% 
  ungroup() %>% 
  group_by(epoch, island, common, position) %>%
  summarize(n_present = mean(qty)) %>% 
  mutate(p_sp_on_habitat = n_present / sum(n_present)) %>% 
  subset(common %in% focal_species) %>% 
  left_join(position_key, by = c("position" = "short_name"))
```

```{r}
habitat_colors <- c("vegetation" = "#4DAF4A", 
                    "mudflat" = "#a65628",
                    "rock_sand" = "#E5C494",
                    "floating_on_water" = "#08519C", 
                    "standing_in_water" = "#6BAED6",
                    "over_water" = "#9ECAE1"
                    )
habitat_fill_scale <- scale_fill_manual(name = "Habitat", values = habitat_colors)
```


```{r}
focal_species_habitat %>% 
  subset(!is.na(long_name)) %>% 
  ggplot(aes(x = epoch, y = p_sp_on_habitat, fill = long_name)) +
  geom_bar(stat = "identity") + 
  facet_wrap(~common) + 
  theme_bw() +
  theme(legend.title = element_blank(), legend.position = "bottom") + 
  scale_y_continuous(breaks = c(0,1)) +
  habitat_fill_scale +
  labs(x = "Before/After Restoration", y = "frequency on habitat", title = "Aramburu: Use of Habitat Before vs. After Restoration")
```


# Outputs

## Table w avg species count/survey, by year

Save csv to data directory (data/species_count_by_year.csv)

```{r}
# dat %>% 
#   group_by(obs_date, island, tide_hl, common) %>% 
#   summarize(qty = sum(qty)) %>% 
#   # fill qty with 0s when bird was not recorded on a given day:
#   tidyr::spread(common, qty) %>% 
#   tidyr::gather(common, qty, -obs_date, -island, -tide_hl) %>% 
#   replace_na(list(qty = 0)) %>% 
#   mutate(year = lubridate::year(obs_date)) %>% 
#   group_by(island, year, tide_hl, common) %>% 
#   summarize(mean_observed = mean(qty)) %>% 
#   subset(common != "<NA>") %>% 
#   subset(!is.na(year)) %>% 
#   subset(tide_hl %in% c("low", "high")) %>% #exclude "mid"
#   tidyr::spread(year, mean_observed) %>% 
#   arrange(island, tide_hl) %>% 
#   write.csv("data/species_count_by_year.csv", row.names = FALSE)

```

Raw data, per JK request
```{r}
# dat %>% 
#   write.csv("data/formatted_raw_data.csv", row.names = FALSE)
```

Table of unique species on each island after construction
```{r}
dat %>%
  subset(is_bird) %>%
  group_by(epoch, island, common) %>%
  summarize(qty = sum(qty)) %>% 
  arrange(epoch, island, common) %>% 
  write.csv("data/species_per_island.csv", row.names = FALSE)
```

