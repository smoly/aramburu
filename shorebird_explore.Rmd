---
title: "Aramburu Shorebird Survey"
author: Alex S.
output: 
  html_document:
    number_sections: no
    theme: journal
    toc: yes
    toc_float:
      collapsed: no
  pdf_document:
    toc: yes
date: "Last Updated: `r format(Sys.time(), '%Y-%m-%d')`" 
---

```{r setup, include=FALSE, echo=FALSE, cache=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      include = TRUE,
                      cache = TRUE,
                      warning = FALSE, 
                      message = FALSE)

library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(lubridate)
library(readxl)
library(broom)

# Utils
g <- function(.) glimpse(.)

medium_fonts <- ggplot2::theme_bw() +
  ggplot2::theme(
    plot.title = ggplot2::element_text(size = 14),
    axis.text.x = ggplot2::element_text(size = 12),
    axis.text.y = ggplot2::element_text(size = 12),
    axis.title.x = ggplot2::element_text(size = 12),
    axis.title.y = ggplot2::element_text(size = 12),
    # legend.title = ggplot2::element_blank(),
    legend.text = ggplot2::element_text(size = 12),
    strip.text.x = ggplot2::element_text(size = 12),
    strip.text.y = ggplot2::element_text(size = 12)
  )

condition_colors <- c("before" = "#FDBF6F", 
                      "construction" = "#A6CEE3", 
                      "after" = "#33A02C")

refresh <- F

```


# Overview

EDA of shorebird data on Aramburu Island following shoreline, wetland, & terrestrial enhancements in 2011-2012. Pickleweed & Unnamed Island are used as controls.

## Goals

1) Is there enough data to make statements about changes in species over time? i.e. can we get statistical significance for differences between Aramburu & Pickelweed.
2) Has the number of species or abundance of any species changed over time on Aramburu vs Pickleweed? Have behaviors changed?
3) Are there differences between high/low tide? 
4) Are there obvious improvements to methodology we can make?

## Qs for Julia

- for a particular observation day it looks like each bird can be in there for every isle, tide, position, behabior, and observer(?)
- were both high and low tide measured for the same amount of time?
- generally ever sampled day is sampled at every tide and at all locations??
- Do we think different observers would have different bird counts?
- Are samples on different islands made on different times of day in a way that might affect results?
- behavior code S is very common but not in index. what is it?

## Data notes

- no obs in 1H 2009, 2H 2012, 2H 2015, and all of 2017
- Observations usually made on all islands on same day and both high and low tide.
- A bird may have multiple rows per observation bc of different behaviors, positions, comments, etc. so important to group by species when doing presence counts.
- NB sometimes we analyze species **presence** (was there/was not) and sometimes individual **count** (how many)

# Load & format data

From Excel file:

ISLE CODES:   
AS = ARAMBURU, SOUTH END.   
AC = ARAMBURU CENTRAL.   
AN = ARAMBURU, NORTH END.    
U = UN-NAMED.   
P = PICKLEWEED.

POSITION CODES:  
V=VEGETATION.  
RS=ROCK/SAND.  
M=MUDFLAT.  
SW=STANDING IN WATER.   
FW=FLOATING ON WATER.  
OW=OVER WATER

BEHAVIOR CODES:  
R=ROOSTING/RESTING.  
F=FORAGING (probing, dabbling, diving, aerial surveying).  
O=OTHER (Comment)


**Keys:**
```{r keys, echo = T}
island_key <- data.frame(
  short_name = c("as", "ac", "an", "u", "p"),
  long_name = c("aramburu_south", "aramburu_central", "aramburu_north", "unnamed", "pickleweed")
)

position_key <- data.frame(
  short_name = c("v", "rs", "m", "sw", "fw", "ow"),
  long_name = c("vegetation", "rock_sand", "mudflat", "standing_in_water", "floating_on_water", "over_water")
)

behavior_key <- data.frame(
  short_name = c("r", "f", "o"),
  long_name = c("roosting", "foraging", "other")
)
```


**Load data:**
```{r load-data, echo = T, include = T}
if (refresh) {
  dat <- read_excel("data/SHOREBIRD_DATA_Complete_2018.xls", sheet = 1) %>% 
    rename_all(tolower) %>%
    select(-analyze, -`pre/post construction`) %>%
    rename(obs_date = date,
           tide_ft = `tide (ft)`,
           tide_hl = `high/low`, # I assume this is tide?
           island = `aram?`,
           aou_num = `aou num`,
           record_num = `record num`,
           gulls = gullls
    ) %>% 
    
    mutate(obs_date = as.Date(obs_date),
           month_no = lubridate::month(obs_date),
           year = lubridate::year(obs_date) # there were many missing year entries, populate here
    ) %>% 
    
    # pre/post improvements (see note under "Change Over Time")
    mutate(epoch = ifelse(obs_date < "2011-09-01", "before", 
                          ifelse(obs_date < "2012-09-01", "construction", "after"))) %>% 
    mutate(epoch = factor(epoch, levels = c("before", "construction", "after"))) %>% 
    
    # species names
    mutate(species = tolower(species)) %>% 
    mutate(species = ifelse(species %in% c("none", "-", "0", NA), "none", species)) %>% 
    mutate(is_bird = !(species %in% c("deer", "humans"))) %>% 
    
    # convert guild to logical
    mutate(shorebirds = grepl("x", tolower(shorebirds)),
           peeps = grepl("x", tolower(peeps)),
           gulls = grepl("x", tolower(gulls)),
           terns = grepl("x", tolower(terns)),
           wading = grepl("x", tolower(wading)),
           grebes = grepl("x", tolower(grebes))
    ) %>% 
    
    # Make MECE guild column (this will further be edited later)
    # In this data all peeps are also shorebirds and there's no "other" 
    # NB should not have any peeps bc classified as shorebirds
    mutate(guild = ifelse(shorebirds, "shorebirds", 
                          ifelse(peeps, "peeps", 
                                 ifelse(gulls, "gulls", 
                                        ifelse(terns, "terns", 
                                               ifelse(wading, "wading", 
                                                      ifelse(grebes, "grebes", NA))))))
    ) %>% 
    
    # clean up behaviors:
    mutate(behavior = ifelse(behavior %in% c("FO", "FV", "FW", "F?", "O,F"), "F", 
                             ifelse(behavior %in% c("O,F", "OW"), "O", 
                                    ifelse(behavior %in% c("R/F", "F/R"), "R/F", 
                                           ifelse(behavior %in% c("?", "FLYOVER"), NA, behavior))))) %>% 
    mutate(behavior = factor(behavior, levels = c("O", "F", "R", "R/F", ""))) %>% 
    
    # tide 
    mutate(tide_hl = gsub('"', "", tolower(tide_hl))) %>% 
    # mutate(tide_hl = factor(tide_hl, levels = "low", "mid", "high")) %>%
    
    # remove some funny data (TODO: check with Julia)
    subset(isle != "ROAMING" & isle != "*") %>% 
    
    # fill missing location data
    mutate(island = ifelse(tolower(isle) %in% c("as", "ac", "an"), "Aramburu", 
                           ifelse(tolower(isle) %in% c("p"), "Pickleweed", "Unnamed")))
  
  # Fill in Guild:
  # guilds of birds with no guild listed in data
  guild_lookup_list <- c("American Coot" = "water_fowl",
                         "American Crow" = "corvid", 
                         "American Robin" = "land_bird",
                         "American Wigeon" = "water_fowl",
                         "Bald Eagle" = "land_bird",
                         "Barn Swallow" = "land_bird",
                         "Belted Kingfisher" = "land_bird",
                         "Black Phoebe" = "land_bird",
                         "Brant" = "water_fowl",
                         "Brown Pelican" = "pelicaniformes",
                         "Bufflehead" = "water_fowl",
                         "Cackling Goose" = "water_fowl",
                         "Canada Goose" = "water_fowl",
                         "Canvasback" = "water_fowl",
                         "Cliff Swallow" = "land_bird",
                         "Common Goldeneye" = "water_fowl",
                         "Common Loon" = "water_fowl",
                         "Common Raven" = "corvid",
                         "Double-crested Cormorant" = "pelicaniformes",
                         "Gadwall" = "water_fowl",
                         "Greater Pewee" = "land_bird",
                         "Greater Scaup" = "water_fowl",
                         "Greater/Lesser Scaup" = "water_fowl",
                         "Green-winged Teal" = "water_fowl",
                         "Lesser Scaup" = "water_fowl",
                         "Loggerhead Shrike" = "land_bird",
                         "Mallard" = "water_fowl",
                         "Northern Flicker" = "land_bird",
                         "Northern Mockingbird" = "land_bird",
                         "Northern Pintail" = "water_fowl",
                         "Northern Shoveler" = "water_fowl",
                         "Osprey" = "land_bird",
                         "Pacific Loon" = "water_fowl",
                         "Pelagic Cormorant" = "pelicaniformes",
                         "Peregrine Falcon" = "land_bird",
                         "Red-breasted Merganser" = "water_fowl",
                         "Red-shouldered Hawk" = "land_bird",
                         "Red-tailed Hawk" = "land_bird",
                         "Red-throated Loon" = "water_fowl",
                         "Rock Pigeon" = "water_fowl",
                         "Ruddy Duck" = "water_fowl",
                         "Say's Phoebe" = "land_bird",
                         "Song Sparrow" = "land_bird",
                         "Surf Scoter" = "water_fowl",
                         "Turkey Vulture" = "land_bird",
                         # "Unidentifiable Bird" = "",
                         "Unidentifiable Cormorant" = "water_fowl",
                         "Unidentifiable Duck" = "water_fowl",
                         "Unidentifiable Loon" = "water_fowl",
                         "Western Bluebird" = "land_bird",
                         "Western Meadowlark" = "land_bird",
                         "Western Scrub-Jay" = "corvid",
                         "White-tailed Kite" = "land_bird")
  
  guild_lookup <- data.frame(common = names(guild_lookup_list), 
                             guild = as.vector(guild_lookup_list)) %>% 
    bind_rows(dat %>% 
                subset(!is.na(guild)) %>%
                distinct(common, guild)) %>% 
    rename(derived_guild = guild)
  
  dat <- dat %>%
    left_join(guild_lookup, by = "common") %>%
    mutate(new_guild = ifelse(is.na(guild), derived_guild, guild)) %>% 
    select(-guild, -derived_guild) %>% 
    rename(guild = new_guild)
  
  saveRDS(dat, "data/dat.rds")
} else {
  dat <- readRDS("data/dat.rds")  
}

dat %>% g
```

# Basic EDA

## Sampling Methods {.tabset}

Observations

- typically all chunks of the island were surveyed on every observation date
- typically measured at both high and low tide, sometimes only one. Occasionaly also "mid" tide.
- data spans 2009-2018, with 1-7 observations per month
- no obs in 1H 2009, 2H 2012, 2H 2015, and all of 2017

### per island

- Survey included all island areas virtually every time

```{r sampling-island}
dat %>% 
  group_by(obs_date, isle) %>% 
  summarize(n_sp = n()) %>% 
  mutate(has_count = !is.na(n_sp)) %>% 
  ggplot(aes(x = factor(obs_date), y = isle, fill = has_count)) +
  geom_raster() +
  scale_x_discrete(breaks = NULL) +
  medium_fonts +
  labs(x = "observation date", y = "island")
```

### per tide level

- tide_ft is usually NA
- usually birds were counted at both high and low tide, but not always 
- will need to control for tide later

```{r sampling-tide-1, include = F}
dat %>% 
  ggplot(aes(tide_ft)) + 
  geom_density(aes(fill = tide_hl), alpha = 0.8)
```


```{r sampling-tide-2}
dat %>% 
  group_by(obs_date, tide_hl) %>% 
  summarize(n_sp = n()) %>% 
  mutate(has_count = !is.na(n_sp)) %>% 
  ggplot(aes(x = factor(obs_date), y = tide_hl, fill = has_count)) +
  geom_raster() +
  scale_x_discrete(breaks = NULL) +
  medium_fonts +
  labs(x = "observation date", y = "tide")
```


### per month

- observations vary 1-7 per month
- missing data in 2017, 2H 2012, 2H 2015

```{r sampling-month}
dat %>% 
  select(isle, year, month_no, obs_date) %>% 
  distinct() %>% 
  group_by(isle, year, month_no) %>% 
  summarize(n_obs = n()) %>% 
  ungroup() %>%
  # complete missing observations:
  tidyr::spread(month_no, n_obs) %>% 
  tidyr::gather(month_no, n_obs, 3:15) %>% 
  mutate(has_count = !is.na(n_obs)) %>% 
  mutate(month_no = as.numeric(month_no)) %>% 
  subset(!is.na(month_no)) %>%
  ggplot(aes(x = month_no, y = year, fill = n_obs)) +
  geom_raster(aes(fill = n_obs)) +
  facet_wrap(~isle) +
  scale_x_continuous(breaks = seq(1,12)) +
  scale_y_continuous(breaks = seq(2009,2018)) +
  theme_bw() +
  labs(title = "Observations per Month")

```

# Tide effects {.tabset}

## Number of Birds

There are more species observed at low tide than high tide, for all islands. This is consistent with known science. Yay. 

```{r tide-diffs}
# number of individuals per species, per date, isle, tide (grouped across observers, behaviors, positions, comments, etc.)
tide_qty_per_sp <- dat %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  group_by(obs_date, island, tide_hl, common) %>% 
  summarize(qty = sum(qty, na.rm = T))

tide_qty_per_sp %>% 
  group_by(obs_date, island, tide_hl) %>%
  summarize(n_species_observed = n()) %>%
  tidyr::spread(tide_hl, n_species_observed) %>% 
  mutate(difference = low-high) %>% 
  ggplot(aes(difference)) +
  geom_vline(xintercept = 0, linetype = 2) +
  geom_bar(alpha = 0.9) +
  facet_wrap(~island) +
  medium_fonts +
  labs(x = "difference", y = "number of sampling days", 
       title = "High vs. Low Tide difference in # species observed", 
       subtitle = "positive values: low tide has more species", 
       caption = "(paired comparison)")
```

## Species Presence

Species whose presence (binary) is significantly different between low & high tide.

```{r tide-diffs-sig}
tide_qty <- tide_qty_per_sp %>% 
  group_by(island, tide_hl, common) %>% 
  summarize(n_times_sp_observed = n()) %>% 
  # fill missing values with 0s:
  tidyr::spread(tide_hl, n_times_sp_observed) %>% # number times species was observed
  replace_na(list(high = 0, low = 0)) %>% 
  tidyr::gather(tide_hl, n_times_sp_observed, high, low) %>% 
  left_join(
    tide_qty_per_sp %>% 
      group_by(island, tide_hl) %>% 
      summarize(n_surveyed = length(unique(obs_date))),
    by = c("island", "tide_hl")
  ) 

tide_diffs <- tide_qty %>% 
  group_by(island, common) %>%
  arrange(tide_hl) %>% 
  do(tidy(prop.test(.$n_times_sp_observed, .$n_surveyed))) %>% 
  rename(high = estimate1,
         low = estimate2)  %>% 
  mutate(difference = low - high) # difference in whether bird was sighted on a survey between low & high tide
```

```{r tide-diffs-plot}
plot_dat <- tide_diffs %>% 
  subset(island == "Aramburu") %>%
  subset(!is.na(common)) %>% 
  subset(p.value < 0.01) %>% 
  select(island, common, low, high) %>% 
  mutate(difference = low-high) %>% 
  mutate(diff_type = ifelse(low > high, "more at low tide", "fewer at low tide")) %>% 
  tidyr::gather(tide_hl, frequency, low, high) %>% 
  mutate(tide_hl = factor(tide_hl, levels = c("low", "high"))) %>% 
  mutate(tide_hl_num = as.numeric(tide_hl)) 

plot_dat %>% 
  ggplot(aes(x = tide_hl_num, y = frequency)) +
  geom_line(aes(color = common)) +
  geom_point(aes(color = common), size = 3) +
  geom_text(data = subset(plot_dat, tide_hl_num == 1), aes(label = common, color = common), 
            size = 3, hjust = 1.15, fontface = "bold") +
  geom_text(data = subset(plot_dat, tide_hl_num == 2), aes(label = common, color = common), 
            size = 3, hjust = -0.15, fontface = "bold") +
  facet_wrap(~diff_type) + 
  medium_fonts +
  theme(strip.text.x = ggplot2::element_text(size = 10), 
        legend.position = "none") +
  scale_x_continuous(limits = c(0.0, 3), breaks = c(1,2), labels = c("low", "high"), minor_breaks = NULL) +
  labs(x = "Tide", y = "Frequency Species is Observed (per survey)", 
       title = "Species with significantly different presence at low vs. high tide",
       subtitle = "Aramburu Island",
       caption = "only species with p < 0.01, chi-squared test")

```

List birds sorted by difference in presence at high vs low tide.

```{r tide-diffs-list}
tide_diffs %>% 
  subset(island == "Aramburu") %>%
  subset(!is.na(common)) %>% 
  mutate(difference = low-high) %>% 
  select(island, common, low, high, difference, p.value) %>% 
  mutate(diff_type = ifelse(low > high, "more at low tide", "fewer at low tide")) %>% 
  arrange(desc(abs(difference)))
```

## Guild Presence

```{r guild-presence, echo = F}
tide_guild_qty <- dat %>%
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>%
  group_by(island, tide_hl, guild) %>%
  summarize(qty = sum(qty, na.rm = T))

# append n observed (not idempot.; need to run above lines first)
tide_guild_qty <- tide_guild_qty %>%
  left_join(tide_guild_qty %>%
              group_by(island, tide_hl) %>%
              summarize(total_observed = sum(qty)),
            by = c("island", "tide_hl")) %>%
  mutate(p_observed = qty/total_observed)


tide_guild_diffs <- tide_guild_qty %>%
  group_by(island, guild) %>%
  arrange(tide_hl) %>%
  do(tidy(prop.test(.$qty, .$total_observed))) %>%
  mutate(is_signif = p.value < 0.01) %>% 
  rename(high = estimate1,
         low = estimate2)  %>%
  mutate(difference = low - high) # difference in whether bird was sighted on a survey between low & high tide

tide_guild_diffs %>% g
```


```{r guild-plot}
plot_dat <- tide_guild_diffs %>% 
  tidyr::gather(tide_hl, proportion, low, high) %>% 
  mutate(tide_hl = factor(tide_hl, levels = c("low", "high"))) %>% 
  mutate(tide_hl_num = as.numeric(tide_hl)) 

plot_dat %>% 
  ggplot(aes(x = tide_hl_num, y = proportion)) +
  geom_line(aes(color = guild)) +
  geom_point(aes(color = guild), size = 3) +
  geom_text(data = subset(plot_dat, tide_hl_num == 1), aes(label = guild, color = guild), 
            size = 3, hjust = 1.15, fontface = "bold") +
  geom_text(data = subset(plot_dat, tide_hl_num == 2), aes(label = guild, color = guild), 
            size = 3, hjust = -0.15, fontface = "bold") +
  facet_wrap(~island) + 
  medium_fonts +
  theme(strip.text.x = ggplot2::element_text(size = 10), 
        legend.position = "none") +
  scale_x_continuous(limits = c(0.0, 3), breaks = c(1,2), labels = c("low", "high"), minor_breaks = NULL) +
  labs(x = "Tide", y = "Frequency Individual is Observed", 
       title = "Guild Representation at Low vs. High Tide", 
       caption = "All Guilds Shown")

plot_dat %>% 
  select(guild, difference, conf.low, conf.high) %>% 
  distinct() %>% # dedup bc each difference is in there twice
  ggplot(aes(x = reorder(guild, difference), y = difference)) +
  geom_bar(stat = "identity") + 
  geom_errorbar(aes(ymin = -conf.low, ymax = -conf.high), width = 0.2) +
  facet_wrap(~island) + 
  medium_fonts +
  coord_flip() +
  labs(x = "", y = "Difference (Low - High)", 
       title = "Difference in Guild Representation bet. Low & High Tide",
       subtitle = "Positive Values: more at low tide")
```


# Changes over time

Timeline

- fall 2011: shoreline enhancements
- summer 2012: wetland & terrestrial enhancements
- tldr:
- `before`: before fall 2011
- `construction`: fall 2011 - summer 2012 (??)
- `after`: after Sept 2012

From JK: "shoreline enhancement elements of the project were constructed in the fall of 2011, so I would say, starting January 2012, any data collected would be “post” construction.  The wetland and terrestrial enhancement elements on the island terrace were constructed in the summer of 2012. So there are sort of two “post” restoration periods. But because the shorebird surveys are only along the eastern shoreline, I would stick with Jan 2012 on as “post” restoration."


```{r sp-count-ts}
sp_count <- dat %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  group_by(obs_date, island, tide_hl, common) %>% 
  summarize(qty = sum(qty, na.rm = T)) %>% 
  mutate(species_observed_flag = ifelse(qty > 0, 1, 0)) %>% 
  group_by(obs_date, island, tide_hl) %>%
  summarize(n_species = sum(species_observed_flag),
            n_individuals = sum(qty)) %>% 
  ungroup() %>% 
  mutate(epoch = ifelse(obs_date < "2011-09-01", "before", 
                        ifelse(obs_date < "2012-09-01", "construction", "after"))) %>% 
  mutate(epoch = factor(epoch, levels = c("before", "construction", "after"))) %>% 
  mutate(month_no = factor(lubridate::month(obs_date)))
```

## High-level ts {.tabset}

- all decreasing, esp since 2014
- Aramburu decreased less

### Species Count
```{r sp-count-ts-plot}  
sp_count %>% 
  ggplot(aes(x = obs_date, y = n_species, group = tide_hl)) +
  geom_vline(xintercept = as.Date("2011-09-01")) +
  geom_vline(xintercept = as.Date("2012-09-01")) +
  geom_point(aes(color = tide_hl), size = 1, alpha = 0.8) +
  geom_smooth(aes(color = tide_hl, fill = tide_hl)) +
  # medium_fonts +
  theme_bw() +
  facet_wrap(~island) +
  labs(title = "Species Count")
```

### Individual Count

```{r ind-count-ts-plot}
sp_count %>% 
  ggplot(aes(x = obs_date, y = n_individuals, group = tide_hl)) +
  geom_vline(xintercept = as.Date("2011-09-01")) +
  geom_vline(xintercept = as.Date("2012-09-01")) +
  geom_point(aes(color = tide_hl), size = 1, alpha = 0.8) +
  geom_smooth(aes(color = tide_hl, fill = tide_hl)) +
  # medium_fonts +
  theme_bw() +
  scale_y_log10(limits = c(NA, 2000)) +
  facet_wrap(~island) +
  labs(title = "Individual Count", y = "log10(n_individuals)")
```

```{r sp-count-ts-samples, include = F, echo = F}
sp_count %>% 
  group_by(epoch) %>% 
  summarize(n_samples = length(unique(obs_date)))
```

## Aggregate Species Count

```{r sp-count-ts-hist}
sp_count %>% 
  subset(epoch %in% c("before", "after")) %>% 
  ggplot(aes(n_species, group = interaction(island, epoch, tide_hl))) +
  # geom_bar(aes(fill = epoch), position = "dodge") +
  geom_density(aes(fill = epoch), alpha = 0.6) +
  facet_grid(tide_hl~island) +
  scale_fill_manual(values = condition_colors) +
  theme_bw() +
  labs(title = "Species Count",
       x = "number of species observed")

# sp_count %>% 
#   subset(obs_date < as.Date("2017-01-01")) %>% 
#   subset(epoch %in% c("before", "after")) %>% 
#   ggplot(aes(n_species, group = interaction(island, epoch, tide_hl))) +
#   geom_density(aes(fill = epoch), position = "dodge", alpha = 0.6) +
#   facet_grid(tide_hl~island) +
#   scale_fill_manual(values = condition_colors) +
#   theme_bw() +
#   labs(title = "Species Count", subtitle = "Excludes data after 2017")
```

Fit lm to control for counfounding:
```{r sp-count-ts-lm}
sp_count_for_model <- sp_count %>% 
  subset(epoch %in% c("before", "after")) %>% 
  subset(!is.na(n_species))

lm_nsp <- lm(n_species ~ epoch 
             + island 
             + epoch:island 
             + tide_hl
             + month_no, 
             data = sp_count_for_model)

summary(lm_nsp)

sp_count_for_model$predict_n_species <- predict(lm_nsp)
```

Effect Size: 
```{r sp-count-ts-effect-size, echo=F}
sprintf("Aramburu has %2.2f more species vs. Pickleweed when comparing changes before vs. after restoration.", -lm_nsp$coefficients[["epochafter:islandPickleweed"]])

sprintf("Aramburu has %2.2f more species vs. Unnamed Island when comparing changes before vs. after restoration.", -lm_nsp$coefficients[["epochafter:islandUnnamed"]])
```


Sanity check w/ G-comp for treatement effect size. Result should be the same.
```{r sp-count-ts-gcomp}
delta_aramburu <- (mean(predict(lm_nsp, newdata = sp_count_for_model %>% 
                                  mutate(island = "Aramburu", 
                                         epoch = "after")))) - 
  (mean(predict(lm_nsp, newdata = sp_count_for_model %>% 
                  mutate(island = "Aramburu", 
                         epoch = "before")))) 

delta_pickleweed <- (mean(predict(lm_nsp, newdata = 
                                    sp_count_for_model %>% 
                                    mutate(island = "Pickleweed", 
                                           epoch = "after")))) -  #7.675406
  (mean(predict(lm_nsp, newdata = sp_count_for_model %>% 
                  mutate(island = "Pickleweed", 
                         epoch = "before")))) #9.424297

sprintf("G-comp estimate for Aramburu vs. Pickleweed: +%2.2f species", delta_aramburu - delta_pickleweed)

```


Sanity check predictions:
```{r sp-count-ts-prediction-plot}
sp_count_for_model %>% 
  group_by(island, tide_hl, epoch, month_no) %>% 
  summarize(mean_actual = mean(n_species),
            mean_predicted = mean(predict_n_species)) %>% 
  ggplot(aes(x = mean_actual, y = mean_predicted)) +
  geom_point(aes(color = island)) +
  geom_abline() 
```

## Individual Abundance
```{r indiv-count-ts}
sp_count %>% 
  subset(epoch %in% c("before", "after")) %>% 
  ggplot(aes(n_individuals, group = interaction(island, epoch, tide_hl))) +
  # geom_bar(aes(fill = epoch), position = "dodge") +
  geom_density(aes(fill = epoch), alpha = 0.6) +
  facet_grid(tide_hl~island) +
  scale_fill_manual(values = condition_colors) +
  scale_x_log10() +
  # xlim(0,1000) +
  theme_bw() +
  labs(title = "Individuals Count",
       x = "individuals observed",
       y = "log10(density)")
```

Fit lm to control for counfounding:
NB: log10!

```{r indiv-count-lm}
sp_abundance_for_model <- sp_count %>% 
  subset(epoch %in% c("before", "after")) %>% 
  subset(!is.na(n_individuals)) %>% 
  mutate(n_individuals_log10 = log10(n_individuals + 0.001)) %>% 
  mutate(log_0_flag = n_individuals == 0)

lm_nindiv <- lm(n_individuals_log10 ~  
                  + log_0_flag
                + island 
                + epoch:island 
                + tide_hl
                + month_no, 
                data = sp_abundance_for_model)

summary(lm_nindiv)

sp_abundance_for_model$predict_n_indiv <- predict(lm_nindiv)
```

Sanity check predictions:

```{r indiv-count-predict}
sp_abundance_for_model %>% 
  group_by(island, tide_hl, epoch, month_no) %>% 
  summarize(mean_actual = mean(n_individuals_log10),
            mean_predicted = mean(predict_n_indiv)) %>% 
  ggplot(aes(x = mean_actual, y = mean_predicted)) +
  geom_point(aes(color = island)) +
  geom_abline() 
```

## Indiv. Species 

- Fit model; Aramburu only. 
- Significant interactions between epoch and species means that there was a significant change.
- Not really enough data to talk about individual species.
- NB this is a lower bound on variance, we should really be comparing to Pickleweed or Unnamed, in which case the variance here would be added to the variance of Pickleweed or Unnamed Island 

```{r indiv-sp-count-lm}
# library(lme4) # not used

# number of individuals per species, per date, isle, tide (grouped across observers, behaviors, positions, comments, etc.)
tide_qty_per_sp_ar <- dat %>% 
  # choose only Aramburu birds
  subset(island == "Aramburu") %>% 
  subset(epoch %in% c("before", "after")) %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  subset(!grepl(pattern = "Unidentif", x = common)) %>% 
  # summarize to get total quantity of a species
  group_by(obs_date, island, epoch, tide_hl, common) %>% 
  summarize(qty = sum(qty, na.rm = T)) %>% 
  mutate(month_no = factor(lubridate::month(obs_date)))

lm_nind <- lm(qty ~ 
                + epoch
              + common
              + month_no
              + tide_hl
              + epoch:common
              # + (1 | common) # ICC = .10 w/ lmer
              , 
              data = tide_qty_per_sp_ar)

# summary(lm_nind)

nind_coeff <- broom::tidy(lm_nind) 
```


```{r indiv-sp-count-plot, fig.height = 6, fig.width=6}
nind_coeff %>% 
  subset(grepl("epochafter:common", term)) %>% 
  mutate(species = gsub("epochafter:common", "", term)) %>% 
  # arrange(estimate) %>% 
  ggplot(aes(x = reorder(species, estimate), y = estimate)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = estimate - 1.96*std.error, ymax = estimate + 1.96*std.error)) +
  coord_flip() +
  theme_bw() + 
  labs(x = "", y = "", 
       title = "Aramburu: Individuals of each species after vs. before improvements",
       subtitle = "positive values: more individuals after improvements")
```


## Guilds

- Fit model; Aramburu only. 
- Significant interactions between epoch and species means that there was a significant change.
- Not really enough data to talk about guilds either

```{r guild-count-lm}
# library(lme4) # not used

# number of individuals per species, per date, isle, tide (grouped across observers, behaviors, positions, comments, etc.)
tide_qty_per_guild_ar <- dat %>% 
  # choose only Aramburu birds
  subset(island == "Aramburu") %>% 
  subset(epoch %in% c("before", "after")) %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  # summarize to get total quantity of a species
  group_by(obs_date, island, epoch, tide_hl, guild) %>% 
  summarize(qty = sum(qty, na.rm = T)) %>% 
  mutate(month_no = factor(lubridate::month(obs_date)))

lm_nguild <- lm(qty ~ 
                  + epoch
                + guild
                + month_no
                + tide_hl
                + epoch:guild
                # + (1 | common) # ICC = .10 w/ lmer; not used
                , 
                data = tide_qty_per_guild_ar)

# summary(lm_nind)

nguild_coeff <- broom::tidy(lm_nguild) 
```


```{r guild-count-plot}
nguild_coeff %>% 
  subset(grepl("epochafter:guild", term)) %>% 
  mutate(guild = gsub("epochafter:guild", "", term)) %>% 
  # arrange(estimate) %>% 
  ggplot(aes(x = reorder(guild, estimate), y = estimate)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = estimate - 1.96*std.error, ymax = estimate + 1.96*std.error)) +
  # coord_flip() +
  theme_bw() + 
  labs(x = "", y = "", 
       title = "Aramburu: Individuals of each guild after vs. before improvements",
       subtitle = "positive values: more individuals after improvements")
```

## Behaviors
```{r}
behaviors <- dat %>% 
  # choose only Aramburu birds
  subset(island == "Aramburu") %>% 
  subset(epoch %in% c("before", "after")) %>% 
  subset(tide_hl %in% c("low", "high")) %>%
  subset(is_bird) %>% 
  # summarize to get total quantity of a species
  group_by(obs_date, island, epoch, tide_hl, common, behavior) %>% 
  summarize(qty = sum(qty, na.rm = T)) %>% 
  mutate(month_no = factor(lubridate::month(obs_date)))

lm_behav <- lm(qty ~ 
                 + epoch
               + behavior
               + month_no
               + tide_hl
               # + common
               + epoch:behavior
               # + (1 | common) # ICC = .10 w/ lmer
               , 
               data = behaviors)

behav_coeff <- broom::tidy(lm_behav) 

summary(lm_behav)
```

```{r}
behav_coeff %>% 
  subset(grepl("epochafter:behavior", term)) %>% 
  mutate(behavior = tolower(gsub("epochafter:behavior", "", term))) %>% 
  left_join(behavior_key, by = c("behavior" = "short_name")) %>% 
  ggplot(aes(x = reorder(long_name, estimate), y = estimate)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = estimate - 1.96*std.error, ymax = estimate + 1.96*std.error), width = 0.2) +
  geom_label(aes(label =  sprintf("%2.2f", estimate))) +
  theme_bw() + 
  labs(x = "", y = "", 
       title = "Aramburu: Behavior after vs. before improvements",
       subtitle = "positive values: more of the behavior after improvements")
```

# Outputs

## Table w avg species count/survey, by year

Save csv to data directory
```{r}
dat %>% 
  group_by(obs_date, island, tide_hl, common) %>% 
  summarize(qty = sum(qty)) %>% 
  # fill qty with 0s when bird was not recorded on a given day:
  tidyr::spread(common, qty) %>% 
  tidyr::gather(common, qty, -obs_date, -island, -tide_hl) %>% 
  replace_na(list(qty = 0)) %>% 
  mutate(year = lubridate::year(obs_date)) %>% 
  group_by(island, year, tide_hl, common) %>% 
  summarize(mean_observed = mean(qty)) %>% 
  subset(common != "<NA>") %>% 
  subset(!is.na(year)) %>% 
  subset(tide_hl %in% c("low", "high")) %>% #exclude "mid"
  tidyr::spread(year, mean_observed) %>% 
  arrange(island, tide_hl) %>% 
  write.csv("data/species_count_by_year.csv", row.names = FALSE)
  

```

